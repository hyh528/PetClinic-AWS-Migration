name: Terraform Infrastructure Deployment

on:
  push:
    branches: [ main ]
    paths:
      - 'terraform/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'terraform/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'dev'
        type: choice
        options:
        - dev
        - staging
        - prod
      action:
        description: 'Terraform action'
        required: true
        default: 'plan'
        type: choice
        options:
        - plan
        - apply
        - destroy

env:
  TF_VERSION: "1.8.5"
  AWS_REGION: "ap-northeast-1"  # ë„ì¿„ ë¦¬ì „ìœ¼ë¡œ ë³€ê²½

jobs:
  # Terraform ì •ì  ê²€ì¦ (ëª¨ë“  ì´ë²¤íŠ¸ì—ì„œ ì‹¤í–‰)
  terraform-validate:
    name: Terraform Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Format Check
        run: terraform fmt -check -recursive terraform/

      - name: Terraform Validate All Modules
        run: |
          for module in terraform/modules/*/; do
            echo "Validating $module"
            cd "$module"
            terraform init -backend=false
            terraform validate
            cd - > /dev/null
          done

      - name: Run TFLint
        uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: latest

      - name: TFLint Check
        run: |
          tflint --init
          tflint --recursive terraform/

      - name: Run Checkov Security Scan
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: terraform/
          framework: terraform
          output_format: sarif
          output_file_path: checkov-results.sarif

  # Terraform Plan (PR ë˜ëŠ” ìˆ˜ë™ ì‹¤í–‰ ì‹œ)
  terraform-plan:
    name: Terraform Plan
    runs-on: ubuntu-latest
    needs: terraform-validate
    if: github.event_name == 'pull_request' || (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'plan')
    strategy:
      matrix:
        environment: [dev]
        layer: 
          - "01-network"
          - "02-security" 
          - "03-database"
          - "04-parameter-store"
          - "05-cloud-map"
          - "06-lambda-genai"
          - "07-application"
          - "08-api-gateway"
          - "09-monitoring"
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Terraform Init
        working-directory: terraform/envs/${{ matrix.environment }}/${{ matrix.layer }}
        run: terraform init

      - name: Terraform Plan
        working-directory: terraform/envs/${{ matrix.environment }}/${{ matrix.layer }}
        run: |
          terraform plan -var-file=dev.tfvars -out=tfplan -no-color | tee plan.txt

      - name: Comment PR with Plan
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: "terraform-plan-${{ matrix.environment }}-${{ matrix.layer }}"
          message: |
            ## ğŸ—ï¸ Terraform Plan: `${{ matrix.environment }}/${{ matrix.layer }}`
            
            <details>
            <summary>ğŸ“‹ Plan Output</summary>
            
            ```terraform
            ${{ steps.plan.outputs.stdout }}
            ```
            </details>
            
            *Plan generated at: ${{ github.sha }}*

  # Terraform Apply (main ë¸Œëœì¹˜ í‘¸ì‹œ ë˜ëŠ” ìˆ˜ë™ ì‹¤í–‰ ì‹œ)
  terraform-apply:
    name: Terraform Apply
    runs-on: ubuntu-latest
    needs: terraform-validate
    if: (github.event_name == 'push' && github.ref == 'refs/heads/main') || (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'apply')
    environment: 
      name: ${{ github.event.inputs.environment || 'dev' }}
      url: https://console.aws.amazon.com/
    
    strategy:
      matrix:
        include:
          - environment: dev
            layers: ["01-network", "02-security", "03-database", "04-parameter-store", "05-cloud-map", "06-lambda-genai", "07-application", "08-api-gateway", "09-monitoring"]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Apply Infrastructure Layers
        run: |
          echo "ğŸš€ Starting infrastructure deployment for ${{ matrix.environment }}"
          
          for layer in ${{ join(matrix.layers, ' ') }}; do
            echo "=========================================="
            echo "ğŸ—ï¸ Deploying layer: $layer"
            echo "=========================================="
            
            cd terraform/envs/${{ matrix.environment }}/$layer
            
            # Terraform ì´ˆê¸°í™”
            terraform init
            
            # Terraform ì ìš©
            terraform apply -var-file=dev.tfvars -auto-approve
            
            if [ $? -eq 0 ]; then
              echo "âœ… $layer deployed successfully"
            else
              echo "âŒ $layer deployment failed"
              exit 1
            fi
            
            cd - > /dev/null
            echo ""
          done
          
          echo "ğŸ‰ All infrastructure layers deployed successfully!"

      - name: Output Infrastructure Info
        run: |
          echo "ğŸ“Š Infrastructure Deployment Summary"
          echo "Environment: ${{ matrix.environment }}"
          echo "Layers: ${{ join(matrix.layers, ', ') }}"
          echo "Region: ${{ env.AWS_REGION }}"
          echo "Commit: ${{ github.sha }}"

  # Terraform Destroy (ìˆ˜ë™ ì‹¤í–‰ë§Œ)
  terraform-destroy:
    name: Terraform Destroy
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'destroy'
    environment: 
      name: ${{ github.event.inputs.environment }}
      url: https://console.aws.amazon.com/
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Destroy Infrastructure
        run: |
          echo "âš ï¸ DESTROYING infrastructure for ${{ github.event.inputs.environment }}"
          echo "This action is IRREVERSIBLE!"
          
          # ì—­ìˆœìœ¼ë¡œ ë ˆì´ì–´ ì œê±°
          layers=("09-monitoring" "08-api-gateway" "07-application" "06-lambda-genai" "05-cloud-map" "04-parameter-store" "03-database" "02-security" "01-network")
          
          for layer in "${layers[@]}"; do
            echo "ğŸ—‘ï¸ Destroying layer: $layer"
            cd terraform/envs/${{ github.event.inputs.environment }}/$layer
            terraform init
            terraform destroy -var-file=dev.tfvars -auto-approve
            cd - > /dev/null
          done