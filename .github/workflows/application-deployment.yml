name: Spring Boot Application Deployment

on:
  push:
    branches: [main]
    paths:
      - "spring-petclinic-*/**"
      - "pom.xml"
  pull_request:
    branches: [main]
    paths:
      - "spring-petclinic-*/**"
      - "pom.xml"
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment"
        required: true
        default: "dev"
        type: choice
        options:
          - dev
          - staging
          - prod
      services:
        description: 'Services to deploy (comma-separated or "all")'
        required: true
        default: "all"
        type: string

env:
  JAVA_VERSION: "17"
  AWS_REGION: "ap-northeast-1"  # ë„ì¿„ ë¦¬ì „ìœ¼ë¡œ ë³€ê²½
  REGISTRY_URL: "339713019108.dkr.ecr.ap-northeast-1.amazonaws.com"  # ë„ì¿„ ë¦¬ì „ ECR

jobs:
  # ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸
  build-and-test:
    name: Build and Test Applications
    runs-on: ubuntu-latest
    outputs:
      services: ${{ steps.detect-changes.outputs.services }}
      version: ${{ steps.version.outputs.version }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: "temurin"
          cache: maven

      - name: Generate Version
        id: version
        run: |
          VERSION="$(date +%Y%m%d)-${GITHUB_SHA:0:7}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Generated version: ${VERSION}"

      - name: Detect Changed Services
        id: detect-changes
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            if [ "${{ github.event.inputs.services }}" = "all" ]; then
              SERVICES="api-gateway,customers-service,vets-service,visits-service,admin-server"
            else
              SERVICES="${{ github.event.inputs.services }}"
            fi
          else
            # Git diffë¡œ ë³€ê²½ëœ ì„œë¹„ìŠ¤ ê°ì§€
            CHANGED_SERVICES=""
            
            for service in api-gateway customers-service vets-service visits-service admin-server; do
              if git diff --name-only HEAD~1 HEAD | grep -q "spring-petclinic-${service}/"; then
                if [ -z "$CHANGED_SERVICES" ]; then
                  CHANGED_SERVICES="$service"
                else
                  CHANGED_SERVICES="$CHANGED_SERVICES,$service"
                fi
              fi
            done
            
            # pom.xmlì´ ë³€ê²½ë˜ë©´ ëª¨ë“  ì„œë¹„ìŠ¤ ë¹Œë“œ
            if git diff --name-only HEAD~1 HEAD | grep -q "pom.xml"; then
              CHANGED_SERVICES="api-gateway,customers-service,vets-service,visits-service,admin-server"
            fi
            
            SERVICES="${CHANGED_SERVICES:-api-gateway,customers-service,vets-service,visits-service,admin-server}"
          fi

          echo "services=${SERVICES}" >> $GITHUB_OUTPUT
          echo "Detected services to build: ${SERVICES}"

      - name: Build with Maven
        run: |
          echo "ğŸ”¨ Building Spring Boot applications..."
          mvn clean compile -B -DskipTests

      - name: Run Tests
        run: |
          echo "ğŸ§ª Running unit tests..."
          mvn test -B

      - name: Build Docker Images
        run: |
          echo "ğŸ³ Building Docker images..."
          mvn clean package -B -DskipTests -PbuildDocker

          # ë¹Œë“œëœ ì´ë¯¸ì§€ í™•ì¸
          docker images | grep springcommunity/spring-petclinic

      - name: Save Docker Images
        run: |
          echo "ğŸ’¾ Saving Docker images as artifacts..."
          mkdir -p docker-images

          IFS=',' read -ra SERVICE_ARRAY <<< "${{ steps.detect-changes.outputs.services }}"
          for service in "${SERVICE_ARRAY[@]}"; do
            service=$(echo $service | xargs) # trim whitespace
            IMAGE_NAME="springcommunity/spring-petclinic-${service}"
            
            if docker images --format "table {{.Repository}}" | grep -q "${IMAGE_NAME}"; then
              echo "Saving ${IMAGE_NAME}:latest"
              docker save "${IMAGE_NAME}:latest" | gzip > "docker-images/${service}.tar.gz"
            else
              echo "Warning: Image ${IMAGE_NAME} not found"
            fi
          done

      - name: Upload Docker Images
        uses: actions/upload-artifact@v4
        with:
          name: docker-images-${{ steps.version.outputs.version }}
          path: docker-images/
          retention-days: 7

  # ECRì— ì´ë¯¸ì§€ í‘¸ì‹œ ë° ECS ë°°í¬
  deploy-to-ecs:
    name: Deploy to ECS
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    environment:
      name: ${{ github.event.inputs.environment || 'dev' }}
      url: https://console.aws.amazon.com/ecs/

    strategy:
      matrix:
        service: ${{ fromJson(format('["{0}"]', join(split(needs.build-and-test.outputs.services, ','), '","'))) }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Download Docker Images
        uses: actions/download-artifact@v4
        with:
          name: docker-images-${{ needs.build-and-test.outputs.version }}
          path: docker-images/

      - name: Load Docker Image
        run: |
          SERVICE="${{ matrix.service }}"
          SERVICE=$(echo $SERVICE | xargs) # trim whitespace

          if [ -f "docker-images/${SERVICE}.tar.gz" ]; then
            echo "ğŸ“¥ Loading Docker image for ${SERVICE}"
            docker load < "docker-images/${SERVICE}.tar.gz"
          else
            echo "âŒ Docker image file not found for ${SERVICE}"
            exit 1
          fi

      - name: Login to Amazon ECR
        run: |
          echo "ğŸ” Logging in to Amazon ECR..."
          aws ecr get-login-password --region ${{ env.AWS_REGION }} | \
            docker login --username AWS --password-stdin ${{ env.REGISTRY_URL }}

      - name: Tag and Push to ECR
        run: |
          SERVICE="${{ matrix.service }}"
          SERVICE=$(echo $SERVICE | xargs)
          ENVIRONMENT="${{ github.event.inputs.environment || 'dev' }}"
          VERSION="${{ needs.build-and-test.outputs.version }}"

          # ECR ë¦¬í¬ì§€í† ë¦¬ ì´ë¦„ (í•˜ì´í”ˆ ì œê±°)
          ECR_REPO_NAME=$(echo "petclinic-${SERVICE}" | sed 's/-service//')

          SOURCE_IMAGE="springcommunity/spring-petclinic-${SERVICE}:latest"
          TARGET_IMAGE="${{ env.REGISTRY_URL }}/${ECR_REPO_NAME}:${VERSION}"
          LATEST_IMAGE="${{ env.REGISTRY_URL }}/${ECR_REPO_NAME}:latest"

          echo "ğŸ·ï¸ Tagging image: ${SOURCE_IMAGE} -> ${TARGET_IMAGE}"
          docker tag "${SOURCE_IMAGE}" "${TARGET_IMAGE}"
          docker tag "${SOURCE_IMAGE}" "${LATEST_IMAGE}"

          echo "ğŸ“¤ Pushing to ECR..."
          docker push "${TARGET_IMAGE}"
          docker push "${LATEST_IMAGE}"

          echo "âœ… Successfully pushed ${SERVICE} to ECR"
          echo "ECR_IMAGE=${TARGET_IMAGE}" >> $GITHUB_ENV

      - name: Update ECS Service
        run: |
          SERVICE="${{ matrix.service }}"
          SERVICE=$(echo $SERVICE | xargs)
          ENVIRONMENT="${{ github.event.inputs.environment || 'dev' }}"
          VERSION="${{ needs.build-and-test.outputs.version }}"

          # ECS í´ëŸ¬ìŠ¤í„° ë° ì„œë¹„ìŠ¤ ì´ë¦„
          CLUSTER_NAME="petclinic-cluster-${ENVIRONMENT}"
          SERVICE_NAME="petclinic-${SERVICE}-${ENVIRONMENT}"

          # ECR ì´ë¯¸ì§€ URI
          ECR_REPO_NAME=$(echo "petclinic-${SERVICE}" | sed 's/-service//')
          IMAGE_URI="${{ env.REGISTRY_URL }}/${ECR_REPO_NAME}:${VERSION}"

          echo "ğŸ”„ Updating ECS service: ${SERVICE_NAME}"
          echo "ğŸ“¦ New image: ${IMAGE_URI}"

          # í˜„ì¬ íƒœìŠ¤í¬ ì •ì˜ ê°€ì ¸ì˜¤ê¸°
          TASK_DEFINITION=$(aws ecs describe-task-definition \
            --task-definition "${SERVICE_NAME}" \
            --region ${{ env.AWS_REGION }} \
            --query 'taskDefinition')

          # ìƒˆ íƒœìŠ¤í¬ ì •ì˜ ìƒì„± (ì´ë¯¸ì§€ URI ì—…ë°ì´íŠ¸)
          NEW_TASK_DEFINITION=$(echo $TASK_DEFINITION | jq --arg IMAGE_URI "$IMAGE_URI" \
            '.containerDefinitions[0].image = $IMAGE_URI | 
             del(.taskDefinitionArn) | 
             del(.revision) | 
             del(.status) | 
             del(.requiresAttributes) | 
             del(.placementConstraints) | 
             del(.compatibilities) | 
             del(.registeredAt) | 
             del(.registeredBy)')

          # ìƒˆ íƒœìŠ¤í¬ ì •ì˜ ë“±ë¡
          NEW_TASK_DEF_ARN=$(echo $NEW_TASK_DEFINITION | \
            aws ecs register-task-definition \
            --region ${{ env.AWS_REGION }} \
            --cli-input-json file:///dev/stdin \
            --query 'taskDefinition.taskDefinitionArn' \
            --output text)

          echo "ğŸ“‹ New task definition: ${NEW_TASK_DEF_ARN}"

          # ECS ì„œë¹„ìŠ¤ ì—…ë°ì´íŠ¸
          aws ecs update-service \
            --cluster "${CLUSTER_NAME}" \
            --service "${SERVICE_NAME}" \
            --task-definition "${NEW_TASK_DEF_ARN}" \
            --region ${{ env.AWS_REGION }}

          echo "â³ Waiting for service to stabilize..."
          aws ecs wait services-stable \
            --cluster "${CLUSTER_NAME}" \
            --services "${SERVICE_NAME}" \
            --region ${{ env.AWS_REGION }}

          echo "âœ… Service ${SERVICE_NAME} updated successfully!"

      - name: Verify Deployment
        run: |
          SERVICE="${{ matrix.service }}"
          SERVICE=$(echo $SERVICE | xargs)
          ENVIRONMENT="${{ github.event.inputs.environment || 'dev' }}"

          CLUSTER_NAME="petclinic-cluster-${ENVIRONMENT}"
          SERVICE_NAME="petclinic-${SERVICE}-${ENVIRONMENT}"

          echo "ğŸ” Verifying deployment for ${SERVICE_NAME}"

          # ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
          SERVICE_STATUS=$(aws ecs describe-services \
            --cluster "${CLUSTER_NAME}" \
            --services "${SERVICE_NAME}" \
            --region ${{ env.AWS_REGION }} \
            --query 'services[0].status' \
            --output text)

          RUNNING_COUNT=$(aws ecs describe-services \
            --cluster "${CLUSTER_NAME}" \
            --services "${SERVICE_NAME}" \
            --region ${{ env.AWS_REGION }} \
            --query 'services[0].runningCount' \
            --output text)

          DESIRED_COUNT=$(aws ecs describe-services \
            --cluster "${CLUSTER_NAME}" \
            --services "${SERVICE_NAME}" \
            --region ${{ env.AWS_REGION }} \
            --query 'services[0].desiredCount' \
            --output text)

          echo "Service Status: ${SERVICE_STATUS}"
          echo "Running Tasks: ${RUNNING_COUNT}/${DESIRED_COUNT}"

          if [ "${SERVICE_STATUS}" = "ACTIVE" ] && [ "${RUNNING_COUNT}" = "${DESIRED_COUNT}" ]; then
            echo "âœ… Deployment verification successful!"
          else
            echo "âŒ Deployment verification failed!"
            exit 1
          fi

  # ë°°í¬ ì™„ë£Œ ì•Œë¦¼
  deployment-summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [build-and-test, deploy-to-ecs]
    if: always()

    steps:
      - name: Deployment Summary
        run: |
          echo "ğŸ‰ Spring Boot Application Deployment Summary"
          echo "=============================================="
          echo "Environment: ${{ github.event.inputs.environment || 'dev' }}"
          echo "Services: ${{ needs.build-and-test.outputs.services }}"
          echo "Version: ${{ needs.build-and-test.outputs.version }}"
          echo "Commit: ${{ github.sha }}"
          echo "Deployed at: $(date -u)"
          echo ""

          if [ "${{ needs.deploy-to-ecs.result }}" = "success" ]; then
            echo "âœ… All services deployed successfully!"
          else
            echo "âŒ Some deployments failed. Check the logs above."
          fi
