name: Terraform Integration Tests

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
        description: 'Target environment for integration tests'
      skip-deployment:
        required: false
        type: boolean
        default: false
        description: 'Skip deployment and run tests on existing infrastructure'
      test-suite:
        required: false
        type: string
        default: 'all'
        description: 'Specific test suite to run (all, network, service, database, security, endpoints)'
    outputs:
      test-results:
        description: 'Integration test results summary'
        value: ${{ jobs.integration-tests.outputs.test-results }}
      success:
        description: 'Whether all tests passed'
        value: ${{ jobs.integration-tests.outputs.success }}
  
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod
      test-suite:
        description: 'Test suite to run'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - network_connectivity
          - service_health
          - database_health
          - security_compliance
          - application_endpoints
      skip-deployment:
        description: 'Skip deployment and test existing infrastructure'
        required: false
        default: false
        type: boolean

env:
  AWS_REGION: ap-southeast-2
  PYTHON_VERSION: '3.11'

jobs:
  integration-tests:
    name: Integration Tests (${{ inputs.environment }})
    runs-on: ubuntu-latest
    timeout-minutes: 45
    environment:
      name: ${{ inputs.environment }}
      url: https://console.aws.amazon.com/
    outputs:
      test-results: ${{ steps.run-tests.outputs.results }}
      success: ${{ steps.run-tests.outputs.success }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install Python dependencies
        run: |
          echo "ğŸ“¦ Installing Python dependencies..."
          pip install --upgrade pip
          pip install -r terraform/scripts/requirements.txt
          echo "âœ… Dependencies installed"

      - name: Verify AWS connectivity
        run: |
          echo "ğŸ” Verifying AWS connectivity..."
          aws sts get-caller-identity
          aws ec2 describe-regions --region ${{ env.AWS_REGION }} --output table
          echo "âœ… AWS connectivity verified"

      - name: Wait for infrastructure stability
        if: inputs.skip-deployment == false
        run: |
          echo "â³ Waiting for infrastructure to stabilize after deployment..."
          echo "Environment: ${{ inputs.environment }}"
          
          # ë°°í¬ ì§í›„ì—ëŠ” ë¦¬ì†ŒìŠ¤ê°€ ì™„ì „íˆ ì¤€ë¹„ë˜ì§€ ì•Šì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ëŒ€ê¸°
          sleep 120
          
          echo "âœ… Stability wait completed"

      - name: Prepare test configuration
        id: prepare-config
        run: |
          echo "ğŸ”§ Preparing test configuration..."
          
          CONFIG_FILE="terraform/scripts/integration-test-enhanced.yaml"
          
          # íŠ¹ì • í…ŒìŠ¤íŠ¸ ìŠ¤ìœ„íŠ¸ë§Œ ì‹¤í–‰í•˜ëŠ” ê²½ìš° ì„¤ì • ìˆ˜ì •
          if [ "${{ inputs.test-suite }}" != "all" ]; then
            echo "ğŸ¯ Filtering tests for suite: ${{ inputs.test-suite }}"
            
            # ì„ì‹œ ì„¤ì • íŒŒì¼ ìƒì„± (íŠ¹ì • ìŠ¤ìœ„íŠ¸ë§Œ í¬í•¨)
            python3 -c "
import yaml
import sys

with open('$CONFIG_FILE', 'r') as f:
    config = yaml.safe_load(f)

target_suite = '${{ inputs.test-suite }}'
filtered_suites = [suite for suite in config['test_suites'] if suite['name'] == target_suite]

if not filtered_suites:
    print(f'Test suite {target_suite} not found')
    sys.exit(1)

config['test_suites'] = filtered_suites

with open('terraform/scripts/integration-test-filtered.yaml', 'w') as f:
    yaml.dump(config, f, default_flow_style=False)
"
            CONFIG_FILE="terraform/scripts/integration-test-filtered.yaml"
          fi
          
          echo "config-file=$CONFIG_FILE" >> $GITHUB_OUTPUT
          echo "âœ… Test configuration prepared"

      - name: Run integration tests
        id: run-tests
        run: |
          echo "ğŸ§ª Running integration tests..."
          echo "Environment: ${{ inputs.environment }}"
          echo "Test Suite: ${{ inputs.test-suite }}"
          echo "Config File: ${{ steps.prepare-config.outputs.config-file }}"
          
          cd terraform/scripts
          
          # ê²°ê³¼ íŒŒì¼ ê²½ë¡œ
          RESULTS_FILE="integration-test-results-${{ inputs.environment }}-$(date +%Y%m%d-%H%M%S).json"
          
          # í…ŒìŠ¤íŠ¸ ì‹¤í–‰
          if python3 integration_test_runner.py \
            "${{ steps.prepare-config.outputs.config-file }}" \
            "${{ inputs.environment }}" \
            --region "${{ env.AWS_REGION }}" \
            --output "$RESULTS_FILE" \
            --verbose; then
            
            echo "âœ… Integration tests completed successfully"
            echo "success=true" >> $GITHUB_OUTPUT
            
          else
            echo "âŒ Integration tests failed"
            echo "success=false" >> $GITHUB_OUTPUT
          fi
          
          # ê²°ê³¼ íŒŒì¼ì´ ìƒì„±ë˜ì—ˆëŠ”ì§€ í™•ì¸
          if [ -f "$RESULTS_FILE" ]; then
            echo "results-file=$RESULTS_FILE" >> $GITHUB_OUTPUT
            
            # ê²°ê³¼ ìš”ì•½ ì¶”ì¶œ
            SUMMARY=$(python3 -c "
import json
with open('$RESULTS_FILE', 'r') as f:
    data = json.load(f)
    summary = data['summary']
    print(f\"{summary['passed']}/{summary['total_tests']} tests passed ({summary['success_rate']})\")
")
            echo "results=$SUMMARY" >> $GITHUB_OUTPUT
            
          else
            echo "âš ï¸ Results file not found"
            echo "results=No results available" >> $GITHUB_OUTPUT
          fi

      - name: Generate detailed report
        if: always()
        run: |
          echo "ğŸ“Š Generating detailed test report..."
          
          cd terraform/scripts
          RESULTS_FILE="${{ steps.run-tests.outputs.results-file }}"
          
          if [ -f "$RESULTS_FILE" ]; then
            echo "# ğŸ§ª Integration Test Report" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Environment:** ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
            echo "**Test Suite:** ${{ inputs.test-suite }}" >> $GITHUB_STEP_SUMMARY
            echo "**Region:** ${{ env.AWS_REGION }}" >> $GITHUB_STEP_SUMMARY
            echo "**Timestamp:** $(date -u)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Pythonìœ¼ë¡œ ê²°ê³¼ íŒŒì‹±í•˜ì—¬ ë§ˆí¬ë‹¤ìš´ ìƒì„±
            python3 -c "
import json
import sys

try:
    with open('$RESULTS_FILE', 'r') as f:
        data = json.load(f)
    
    summary = data['summary']
    results = data['results']
    
    print('## ğŸ“Š Summary')
    print(f'- **Total Tests:** {summary[\"total_tests\"]}')
    print(f'- **Passed:** {summary[\"passed\"]} âœ…')
    print(f'- **Failed:** {summary[\"failed\"]} âŒ')
    print(f'- **Errors:** {summary[\"errors\"]} ğŸ’¥')
    print(f'- **Success Rate:** {summary[\"success_rate\"]}')
    print(f'- **Duration:** {summary[\"total_duration_seconds\"]:.2f} seconds')
    print()
    
    # ì„±ê³µí•œ í…ŒìŠ¤íŠ¸
    passed_tests = [r for r in results if r['status'] == 'PASS']
    if passed_tests:
        print('## âœ… Passed Tests')
        for test in passed_tests:
            duration = f\"{test['duration']:.2f}s\"
            print(f'- **{test[\"name\"]}**: {test[\"message\"]} ({duration})')
        print()
    
    # ì‹¤íŒ¨í•œ í…ŒìŠ¤íŠ¸
    failed_tests = [r for r in results if r['status'] in ['FAIL', 'ERROR']]
    if failed_tests:
        print('## âŒ Failed Tests')
        for test in failed_tests:
            duration = f\"{test['duration']:.2f}s\"
            print(f'- **{test[\"name\"]}**: {test[\"message\"]} ({duration})')
            
            # ìƒì„¸ ì •ë³´ê°€ ìˆìœ¼ë©´ í‘œì‹œ
            if test.get('details'):
                print(f'  <details><summary>Details</summary>')
                print(f'  ')
                print(f'  \`\`\`json')
                print(json.dumps(test['details'], indent=2))
                print(f'  \`\`\`')
                print(f'  </details>')
        print()
    
    # ì „ì²´ ìƒíƒœ
    if summary['overall_status'] == 'PASS':
        print('## ğŸ‰ Overall Status: SUCCESS')
        print('All integration tests passed successfully!')
    else:
        print('## âŒ Overall Status: FAILED')
        print('Some integration tests failed. Please review the details above.')

except Exception as e:
    print(f'Error parsing results: {e}')
    sys.exit(1)
" >> $GITHUB_STEP_SUMMARY
            
          else
            echo "## âš ï¸ No Test Results" >> $GITHUB_STEP_SUMMARY
            echo "Integration test results file was not generated." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-results-${{ inputs.environment }}-${{ github.run_number }}
          path: |
            terraform/scripts/integration-test-results-*.json
            terraform/scripts/integration-test-filtered.yaml
          retention-days: 30

      - name: Post test cleanup
        if: always()
        run: |
          echo "ğŸ§¹ Performing post-test cleanup..."
          
          # ì„ì‹œ íŒŒì¼ ì •ë¦¬
          rm -f terraform/scripts/integration-test-filtered.yaml
          
          # í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ ì‹œ ì¶”ê°€ ì •ë³´ ìˆ˜ì§‘
          if [ "${{ steps.run-tests.outputs.success }}" != "true" ]; then
            echo "ğŸ“‹ Collecting additional diagnostic information..."
            
            # AWS ë¦¬ì†ŒìŠ¤ ìƒíƒœ í™•ì¸
            echo "ECS Clusters:"
            aws ecs list-clusters --region ${{ env.AWS_REGION }} || true
            
            echo "RDS Clusters:"
            aws rds describe-db-clusters --region ${{ env.AWS_REGION }} --query 'DBClusters[].{ID:DBClusterIdentifier,Status:Status}' --output table || true
            
            echo "Load Balancers:"
            aws elbv2 describe-load-balancers --region ${{ env.AWS_REGION }} --query 'LoadBalancers[].{Name:LoadBalancerName,State:State.Code}' --output table || true
          fi
          
          echo "âœ… Cleanup completed"

      - name: Notify on failure
        if: failure()
        run: |
          echo "âŒ Integration tests failed for environment: ${{ inputs.environment }}"
          echo "Please check the test results and infrastructure status."
          echo "Test suite: ${{ inputs.test-suite }}"
          echo "Results: ${{ steps.run-tests.outputs.results }}"