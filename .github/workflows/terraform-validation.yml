name: Terraform Validation

on:
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'terraform/**'
      - '.github/workflows/terraform-validation.yml'
  push:
    branches: [ main ]
    paths:
      - 'terraform/**'

env:
  TF_VERSION: '1.8.5'
  TFLINT_VERSION: 'v0.59.1'

jobs:
  terraform-validation:
    name: Terraform Validation
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        layer:
          - '01-network'
          - '02-security'
          - '03-database'
          - '06-lambda-genai'
          - '07-application'
          - '08-api-gateway'
          - '09-aws-native'
          - '10-monitoring'
          - '11-frontend'
          - '12-notification'
    
    defaults:
      run:
        working-directory: terraform/layers/${{ matrix.layer }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: ${{ env.TFLINT_VERSION }}

      - name: Setup Python for Checkov
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Checkov
        run: pip install checkov

      - name: Terraform Format Check
        id: fmt
        run: terraform fmt -check -recursive
        continue-on-error: true

      - name: Terraform Init
        id: init
        run: terraform init -backend=false

      - name: Terraform Validate
        id: validate
        run: terraform validate

      - name: TFLint Init
        run: |
          cd ../../
          tflint --init

      - name: TFLint Check
        id: tflint
        run: |
          cd ../../
          tflint --recursive --format=compact layers/${{ matrix.layer }}
        continue-on-error: true

      - name: Checkov Security Scan
        id: checkov
        run: |
          cd ../../
          checkov -d layers/${{ matrix.layer }} --framework terraform --output cli --compact
        continue-on-error: true

      - name: Comment PR with Results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const layer = '${{ matrix.layer }}';
            const fmtResult = '${{ steps.fmt.outcome }}';
            const validateResult = '${{ steps.validate.outcome }}';
            const tflintResult = '${{ steps.tflint.outcome }}';
            const checkovResult = '${{ steps.checkov.outcome }}';
            
            const getIcon = (result) => result === 'success' ? '✅' : '❌';
            
            const comment = `
            ## Terraform Validation Results - Layer: ${layer}
            
            | Check | Result |
            |-------|--------|
            | Format | ${getIcon(fmtResult)} ${fmtResult} |
            | Validate | ${getIcon(validateResult)} ${validateResult} |
            | TFLint | ${getIcon(tflintResult)} ${tflintResult} |
            | Checkov | ${getIcon(checkovResult)} ${checkovResult} |
            
            ${fmtResult !== 'success' ? '⚠️ **Format issues found. Run `terraform fmt -recursive` to fix.**' : ''}
            ${validateResult !== 'success' ? '⚠️ **Validation failed. Please check your Terraform configuration.**' : ''}
            ${tflintResult !== 'success' ? '⚠️ **TFLint found issues. Please review the recommendations.**' : ''}
            ${checkovResult !== 'success' ? '⚠️ **Checkov found security issues. Please review and fix.**' : ''}
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Fail if critical checks failed
        if: steps.fmt.outcome == 'failure' || steps.validate.outcome == 'failure'
        run: |
          echo "Critical validation checks failed"
          exit 1

  terraform-plan:
    name: Terraform Plan
    runs-on: ubuntu-latest
    needs: terraform-validation
    if: github.event_name == 'pull_request'
    
    strategy:
      matrix:
        layer:
          - '01-network'
          - '02-security'
          - '03-database'
          - '06-lambda-genai'
          - '07-application'
          - '08-api-gateway'
          - '09-aws-native'
          - '10-monitoring'
          - '11-frontend'
          - '12-notification'
    
    defaults:
      run:
        working-directory: terraform/layers/${{ matrix.layer }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2

      - name: Terraform Init
        run: terraform init -backend-config=../../backend.hcl -backend-config=backend.config

      - name: Terraform Plan
        id: plan
        run: terraform plan -var-file=../../envs/dev.tfvars -no-color
        continue-on-error: true

      - name: Comment PR with Plan
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const layer = '${{ matrix.layer }}';
            const planResult = '${{ steps.plan.outcome }}';
            const plan = `${{ steps.plan.outputs.stdout }}`;
            
            const comment = `
            ## Terraform Plan Results - Layer: ${layer}
            
            **Plan Result:** ${planResult === 'success' ? '✅ Success' : '❌ Failed'}
            
            <details>
            <summary>Show Plan Output</summary>
            
            \`\`\`terraform
            ${plan}
            \`\`\`
            
            </details>
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  summary:
    name: Validation Summary
    runs-on: ubuntu-latest
    needs: [terraform-validation, terraform-plan]
    if: always()
    
    steps:
      - name: Check validation results
        run: |
          if [[ "${{ needs.terraform-validation.result }}" == "failure" ]]; then
            echo "❌ Terraform validation failed"
            exit 1
          elif [[ "${{ needs.terraform-plan.result }}" == "failure" && "${{ github.event_name }}" == "pull_request" ]]; then
            echo "❌ Terraform plan failed"
            exit 1
          else
            echo "✅ All checks passed"
          fi