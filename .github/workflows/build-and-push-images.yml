name: ì„œë¹„ìŠ¤ ì´ë¯¸ì§€ ë¹Œë“œ ë° ë°°í¬

on:
   push:
     paths:
       - 'spring-petclinic-*/**'
       - '.github/workflows/build-and-push-images.yml'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
      packages: write
    env:
      ECR_REGISTRY: ${{ secrets.ECR_REGISTRY }}
      AWS_REGION: ap-southeast-2

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Login to ECR
        uses: aws-actions/amazon-ecr-login@v1

      - name: ëª¨ë“  ì„œë¹„ìŠ¤ ë¹Œë“œ
        run: |
          echo "ğŸ”„ ëª¨ë“  ì„œë¹„ìŠ¤ ë¹Œë“œ ì¤‘..."
          ./mvnw clean package -DskipTests -q -f spring-petclinic-customers-service/pom.xml
          ./mvnw clean package -DskipTests -q -f spring-petclinic-vets-service/pom.xml
          ./mvnw clean package -DskipTests -q -f spring-petclinic-visits-service/pom.xml
          ./mvnw clean package -DskipTests -q -f spring-petclinic-admin-server/pom.xml
          echo "âœ… ëª¨ë“  ì„œë¹„ìŠ¤ ë¹Œë“œ ì™„ë£Œ"

      - name: customers-service ë¹Œë“œ ë° í‘¸ì‹œ
        run: |
          echo "ğŸ”„ customers-service ë¹Œë“œ ë° í‘¸ì‹œ ì¤‘..."
          # íƒœê·¸ ìƒì„±
          BRANCH_NAME=$(echo "${{ github.ref_name }}" | sed 's/[^a-zA-Z0-9._-]/-/g')
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          DATE_TAG=$(date +%Y-%m-%d)
          COMBINED_TAG="${BRANCH_NAME}-${DATE_TAG}-${SHORT_SHA}"

          cp spring-petclinic-customers-service/target/spring-petclinic-customers-service-*.jar spring-petclinic-customers-service/app.jar
          cd spring-petclinic-customers-service
          docker build -t customers-service .

          # ë¶ˆë³€ íƒœê·¸ ì ìš©
          docker tag customers-service:latest ${{ env.ECR_REGISTRY }}/petclinic-dev-customers:${COMBINED_TAG}

          # í‘¸ì‹œ (ë¶ˆë³€ íƒœê·¸ë§Œ ì‚¬ìš©)
          docker push ${{ env.ECR_REGISTRY }}/petclinic-dev-customers:${COMBINED_TAG}
          echo "âœ… customers-service í‘¸ì‹œ ì™„ë£Œ (íƒœê·¸: ${COMBINED_TAG})"

      - name: vets-service ë¹Œë“œ ë° í‘¸ì‹œ
        run: |
          echo "ğŸ”„ vets-service ë¹Œë“œ ë° í‘¸ì‹œ ì¤‘..."
          # íƒœê·¸ ìƒì„±
          BRANCH_NAME=$(echo "${{ github.ref_name }}" | sed 's/[^a-zA-Z0-9._-]/-/g')
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          DATE_TAG=$(date +%Y-%m-%d)
          COMBINED_TAG="${BRANCH_NAME}-${DATE_TAG}-${SHORT_SHA}"

          cp spring-petclinic-vets-service/target/spring-petclinic-vets-service-*.jar spring-petclinic-vets-service/app.jar
          cd spring-petclinic-vets-service
          docker build -t vets-service .

          # ë¶ˆë³€ íƒœê·¸ ì ìš©
          docker tag vets-service:latest ${{ env.ECR_REGISTRY }}/petclinic-dev-vets:${COMBINED_TAG}

          # í‘¸ì‹œ (ë¶ˆë³€ íƒœê·¸ë§Œ ì‚¬ìš©)
          docker push ${{ env.ECR_REGISTRY }}/petclinic-dev-vets:${COMBINED_TAG}
          echo "âœ… vets-service í‘¸ì‹œ ì™„ë£Œ (íƒœê·¸: ${COMBINED_TAG})"

      - name: visits-service ë¹Œë“œ ë° í‘¸ì‹œ
        run: |
          echo "ğŸ”„ visits-service ë¹Œë“œ ë° í‘¸ì‹œ ì¤‘..."
          # íƒœê·¸ ìƒì„±
          BRANCH_NAME=$(echo "${{ github.ref_name }}" | sed 's/[^a-zA-Z0-9._-]/-/g')
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          DATE_TAG=$(date +%Y-%m-%d)
          COMBINED_TAG="${BRANCH_NAME}-${DATE_TAG}-${SHORT_SHA}"

          cp spring-petclinic-visits-service/target/spring-petclinic-visits-service-*.jar spring-petclinic-visits-service/app.jar
          cd spring-petclinic-visits-service
          docker build -t visits-service .

          # ë¶ˆë³€ íƒœê·¸ ì ìš©
          docker tag visits-service:latest ${{ env.ECR_REGISTRY }}/petclinic-dev-visits:${COMBINED_TAG}

          # í‘¸ì‹œ (ë¶ˆë³€ íƒœê·¸ë§Œ ì‚¬ìš©)
          docker push ${{ env.ECR_REGISTRY }}/petclinic-dev-visits:${COMBINED_TAG}
          echo "âœ… visits-service í‘¸ì‹œ ì™„ë£Œ (íƒœê·¸: ${COMBINED_TAG})"

      - name: admin-server ë¹Œë“œ ë° í‘¸ì‹œ
        run: |
          echo "ğŸ”„ admin-server ë¹Œë“œ ë° í‘¸ì‹œ ì¤‘..."
          # íƒœê·¸ ìƒì„±
          BRANCH_NAME=$(echo "${{ github.ref_name }}" | sed 's/[^a-zA-Z0-9._-]/-/g')
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          DATE_TAG=$(date +%Y-%m-%d)
          COMBINED_TAG="${BRANCH_NAME}-${DATE_TAG}-${SHORT_SHA}"

          cp spring-petclinic-admin-server/target/spring-petclinic-admin-server-*.jar spring-petclinic-admin-server/app.jar
          cd spring-petclinic-admin-server
          docker build -t admin-server .

          # ë¶ˆë³€ íƒœê·¸ ì ìš©
          docker tag admin-server:latest ${{ env.ECR_REGISTRY }}/petclinic-dev-admin:${COMBINED_TAG}

          # í‘¸ì‹œ (ë¶ˆë³€ íƒœê·¸ë§Œ ì‚¬ìš©)
          docker push ${{ env.ECR_REGISTRY }}/petclinic-dev-admin:${COMBINED_TAG}
          echo "âœ… admin-server í‘¸ì‹œ ì™„ë£Œ (íƒœê·¸: ${COMBINED_TAG})"


      - name: ì´ë¯¸ì§€ ë§¤í•‘ ì•„í‹°íŒ©íŠ¸ ìƒì„±
        run: |
          # Terraform ë³€ìˆ˜ `service_image_map`ì— í•„ìš”í•œ ì´ë¯¸ì§€ URI ë§¤í•‘
          BRANCH_NAME=$(echo "${{ github.ref_name }}" | sed 's/[^a-zA-Z0-9._-]/-/g')
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          DATE_TAG=$(date +%Y-%m-%d)
          COMBINED_TAG="${BRANCH_NAME}-${DATE_TAG}-${SHORT_SHA}"

          # SHA256 ë‹¤ì´ì œìŠ¤íŠ¸ ì¡°íšŒ ë° ì €ì¥
          CUSTOMERS_DIGEST=$(aws ecr describe-images --repository-name petclinic-dev-customers --image-ids imageTag=${COMBINED_TAG} --region ap-southeast-2 --query 'imageDetails[0].imageDigest' --output text)
          VETS_DIGEST=$(aws ecr describe-images --repository-name petclinic-dev-vets --image-ids imageTag=${COMBINED_TAG} --region ap-southeast-2 --query 'imageDetails[0].imageDigest' --output text)
          VISITS_DIGEST=$(aws ecr describe-images --repository-name petclinic-dev-visits --image-ids imageTag=${COMBINED_TAG} --region ap-southeast-2 --query 'imageDetails[0].imageDigest' --output text)
          ADMIN_DIGEST=$(aws ecr describe-images --repository-name petclinic-dev-admin --image-ids imageTag=${COMBINED_TAG} --region ap-southeast-2 --query 'imageDetails[0].imageDigest' --output text)

          echo "customers=${{ env.ECR_REGISTRY }}/petclinic-dev-customers@${CUSTOMERS_DIGEST}" >> images.properties
          echo "vets=${{ env.ECR_REGISTRY }}/petclinic-dev-vets@${VETS_DIGEST}" >> images.properties
          echo "visits=${{ env.ECR_REGISTRY }}/petclinic-dev-visits@${VISITS_DIGEST}" >> images.properties
          echo "admin=${{ env.ECR_REGISTRY }}/petclinic-dev-admin@${ADMIN_DIGEST}" >> images.properties
        shell: bash

      - name: ì´ë¯¸ì§€ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: images
          path: images.properties

      - name: Application Layer ë°°í¬ ì •ë³´ ìƒì„±
        run: |
          echo "ğŸ“ Application Layer ë°°í¬ ì •ë³´ ìƒì„±..."

          # ì´ë¯¸ì§€ íƒœê·¸ ìƒì„± (CI ì›Œí¬í”Œë¡œìš°ì™€ ë™ì¼)
          BRANCH_NAME=$(echo "${{ github.ref_name }}" | sed 's/[^a-zA-Z0-9._-]/-/g')
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          DATE_TAG=$(date +%Y-%m-%d)
          IMAGE_TAG="${BRANCH_NAME}-${DATE_TAG}-${SHORT_SHA}"

          # SHA256 ë‹¤ì´ì œìŠ¤íŠ¸ ì¡°íšŒ ë° í™˜ê²½ë³€ìˆ˜ ì„¤ì •
          CUSTOMERS_DIGEST=$(aws ecr describe-images --repository-name petclinic-dev-customers --image-ids imageTag=${IMAGE_TAG} --region ap-southeast-2 --query 'imageDetails[0].imageDigest' --output text)
          VETS_DIGEST=$(aws ecr describe-images --repository-name petclinic-dev-vets --image-ids imageTag=${IMAGE_TAG} --region ap-southeast-2 --query 'imageDetails[0].imageDigest' --output text)
          VISITS_DIGEST=$(aws ecr describe-images --repository-name petclinic-dev-visits --image-ids imageTag=${IMAGE_TAG} --region ap-southeast-2 --query 'imageDetails[0].imageDigest' --output text)
          ADMIN_DIGEST=$(aws ecr describe-images --repository-name petclinic-dev-admin --image-ids imageTag=${IMAGE_TAG} --region ap-southeast-2 --query 'imageDetails[0].imageDigest' --output text)

          echo "SERVICE_IMAGE_MAP=customers=\"${{ env.ECR_REGISTRY }}/petclinic-dev-customers@${CUSTOMERS_DIGEST}\",vets=\"${{ env.ECR_REGISTRY }}/petclinic-dev-vets@${VETS_DIGEST}\",visits=\"${{ env.ECR_REGISTRY }}/petclinic-dev-visits@${VISITS_DIGEST}\",admin=\"${{ env.ECR_REGISTRY }}/petclinic-dev-admin@${ADMIN_DIGEST}\"" >> $GITHUB_ENV
          echo "IMAGE_TAG=${IMAGE_TAG}" >> $GITHUB_ENV

          echo "âœ… ë°°í¬ ì •ë³´ ìƒì„± ì™„ë£Œ"
          echo "ì´ë¯¸ì§€ íƒœê·¸: ${IMAGE_TAG}"

      - name: Application Layer ë°°í¬ (ìˆ˜ë™)
        run: |
          echo "ğŸš€ Application Layer ë°°í¬ ì¤€ë¹„ ì™„ë£Œ"
          echo "ë‹¤ìŒ ëª…ë ¹ì–´ë¡œ ìˆ˜ë™ ë°°í¬í•˜ì„¸ìš”:"
          echo ""
          echo "cd terraform/layers/07-application"
          echo "terraform init -backend-config=\"../../backend.hcl\" -backend-config=\"backend.config\" -reconfigure"
          echo "TF_VAR_service_image_map='${SERVICE_IMAGE_MAP}' terraform plan -var-file=\"../../envs/dev.tfvars\""
          echo "TF_VAR_service_image_map='${SERVICE_IMAGE_MAP}' terraform apply -auto-approve -var-file=\"../../envs/dev.tfvars\""
          echo ""
          echo "ë˜ëŠ” ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‚¬ìš©:"
          echo "./terraform/scripts/deploy-application.sh dev ${IMAGE_TAG}"
          echo ""
          echo "âœ… GitHub Actionsì—ì„œ ë¹Œë“œ ë° ì´ë¯¸ì§€ í‘¸ì‹œëŠ” ì™„ë£Œë¨"
