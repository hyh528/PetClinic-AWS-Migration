name: ì„œë¹„ìŠ¤ ì´ë¯¸ì§€ ë¹Œë“œ ë° ë°°í¬

on:
  push:
    paths:
      - "spring-petclinic-*/**"
      - ".github/workflows/build-and-push-images.yml"

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
      packages: write
    env:
      ECR_REGISTRY: ${{ secrets.ECR_REGISTRY }}
      AWS_REGION: us-west-2

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: Login to ECR
        uses: aws-actions/amazon-ecr-login@v1

      - name: ëª¨ë“  ì„œë¹„ìŠ¤ ë¹Œë“œ
        run: |
          echo "ğŸ”„ ëª¨ë“  ì„œë¹„ìŠ¤ ë¹Œë“œ ì¤‘..."
          ./mvnw clean package -DskipTests -q -f spring-petclinic-customers-service/pom.xml
          ./mvnw clean package -DskipTests -q -f spring-petclinic-vets-service/pom.xml
          ./mvnw clean package -DskipTests -q -f spring-petclinic-visits-service/pom.xml
          ./mvnw clean package -DskipTests -q -f spring-petclinic-admin-server/pom.xml
          echo "âœ… ëª¨ë“  ì„œë¹„ìŠ¤ ë¹Œë“œ ì™„ë£Œ"

      - name: customers-service ë¹Œë“œ ë° í‘¸ì‹œ
        run: |
          echo "ğŸ”„ customers-service ë¹Œë“œ ë° í‘¸ì‹œ ì¤‘..."
          # íƒœê·¸ ìƒì„±
          BRANCH_NAME=$(echo "${{ github.ref_name }}" | sed 's/[^a-zA-Z0-9._-]/-/g')
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          DATE_TAG=$(date +%Y-%m-%d)
          COMBINED_TAG="${BRANCH_NAME}-${DATE_TAG}-${SHORT_SHA}"

          cp spring-petclinic-customers-service/target/spring-petclinic-customers-service-*.jar spring-petclinic-customers-service/app.jar
          cd spring-petclinic-customers-service
          docker build -t customers-service .

          # ë¶ˆë³€ íƒœê·¸ ì ìš©
          docker tag customers-service:latest ${{ env.ECR_REGISTRY }}/petclinic-dev-customers:${COMBINED_TAG}

          # í‘¸ì‹œ (ë¶ˆë³€ íƒœê·¸ë§Œ ì‚¬ìš©)
          docker push ${{ env.ECR_REGISTRY }}/petclinic-dev-customers:${COMBINED_TAG}

          # latest íƒœê·¸ë„ í‘¸ì‹œ
          docker tag customers-service:latest ${{ env.ECR_REGISTRY }}/petclinic-dev-customers:latest
          docker push ${{ env.ECR_REGISTRY }}/petclinic-dev-customers:latest
          echo "âœ… customers-service í‘¸ì‹œ ì™„ë£Œ (íƒœê·¸: ${COMBINED_TAG}, latest)"

      - name: vets-service ë¹Œë“œ ë° í‘¸ì‹œ
        run: |
          echo "ğŸ”„ vets-service ë¹Œë“œ ë° í‘¸ì‹œ ì¤‘..."
          # íƒœê·¸ ìƒì„±
          BRANCH_NAME=$(echo "${{ github.ref_name }}" | sed 's/[^a-zA-Z0-9._-]/-/g')
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          DATE_TAG=$(date +%Y-%m-%d)
          COMBINED_TAG="${BRANCH_NAME}-${DATE_TAG}-${SHORT_SHA}"

          cp spring-petclinic-vets-service/target/spring-petclinic-vets-service-*.jar spring-petclinic-vets-service/app.jar
          cd spring-petclinic-vets-service
          docker build -t vets-service .

          # ë¶ˆë³€ íƒœê·¸ ì ìš©
          docker tag vets-service:latest ${{ env.ECR_REGISTRY }}/petclinic-dev-vets:${COMBINED_TAG}

          # í‘¸ì‹œ (ë¶ˆë³€ íƒœê·¸ë§Œ ì‚¬ìš©)
          docker push ${{ env.ECR_REGISTRY }}/petclinic-dev-vets:${COMBINED_TAG}

          # latest íƒœê·¸ë„ í‘¸ì‹œ
          docker tag vets-service:latest ${{ env.ECR_REGISTRY }}/petclinic-dev-vets:latest
          docker push ${{ env.ECR_REGISTRY }}/petclinic-dev-vets:latest
          echo "âœ… vets-service í‘¸ì‹œ ì™„ë£Œ (íƒœê·¸: ${COMBINED_TAG}, latest)"

      - name: visits-service ë¹Œë“œ ë° í‘¸ì‹œ
        run: |
          echo "ğŸ”„ visits-service ë¹Œë“œ ë° í‘¸ì‹œ ì¤‘..."
          # íƒœê·¸ ìƒì„±
          BRANCH_NAME=$(echo "${{ github.ref_name }}" | sed 's/[^a-zA-Z0-9._-]/-/g')
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          DATE_TAG=$(date +%Y-%m-%d)
          COMBINED_TAG="${BRANCH_NAME}-${DATE_TAG}-${SHORT_SHA}"

          cp spring-petclinic-visits-service/target/spring-petclinic-visits-service-*.jar spring-petclinic-visits-service/app.jar
          cd spring-petclinic-visits-service
          docker build -t visits-service .

          # ë¶ˆë³€ íƒœê·¸ ì ìš©
          docker tag visits-service:latest ${{ env.ECR_REGISTRY }}/petclinic-dev-visits:${COMBINED_TAG}

          # í‘¸ì‹œ (ë¶ˆë³€ íƒœê·¸ë§Œ ì‚¬ìš©)
          docker push ${{ env.ECR_REGISTRY }}/petclinic-dev-visits:${COMBINED_TAG}

          # latest íƒœê·¸ë„ í‘¸ì‹œ
          docker tag visits-service:latest ${{ env.ECR_REGISTRY }}/petclinic-dev-visits:latest
          docker push ${{ env.ECR_REGISTRY }}/petclinic-dev-visits:latest
          echo "âœ… visits-service í‘¸ì‹œ ì™„ë£Œ (íƒœê·¸: ${COMBINED_TAG}, latest)"

      - name: admin-server ë¹Œë“œ ë° í‘¸ì‹œ
        run: |
          echo "ğŸ”„ admin-server ë¹Œë“œ ë° í‘¸ì‹œ ì¤‘..."
          # íƒœê·¸ ìƒì„±
          BRANCH_NAME=$(echo "${{ github.ref_name }}" | sed 's/[^a-zA-Z0-9._-]/-/g')
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          DATE_TAG=$(date +%Y-%m-%d)
          COMBINED_TAG="${BRANCH_NAME}-${DATE_TAG}-${SHORT_SHA}"

          cp spring-petclinic-admin-server/target/spring-petclinic-admin-server-*.jar spring-petclinic-admin-server/app.jar
          cd spring-petclinic-admin-server
          docker build -t admin-server .

          # ë¶ˆë³€ íƒœê·¸ ì ìš©
          docker tag admin-server:latest ${{ env.ECR_REGISTRY }}/petclinic-dev-admin:${COMBINED_TAG}

          # í‘¸ì‹œ (ë¶ˆë³€ íƒœê·¸ë§Œ ì‚¬ìš©)
          docker push ${{ env.ECR_REGISTRY }}/petclinic-dev-admin:${COMBINED_TAG}

          # latest íƒœê·¸ë„ í‘¸ì‹œ
          docker tag admin-server:latest ${{ env.ECR_REGISTRY }}/petclinic-dev-admin:latest
          docker push ${{ env.ECR_REGISTRY }}/petclinic-dev-admin:latest
          echo "âœ… admin-server í‘¸ì‹œ ì™„ë£Œ (íƒœê·¸: ${COMBINED_TAG}, latest)"

      - name: ì´ë¯¸ì§€ ë§¤í•‘ ì•„í‹°íŒ©íŠ¸ ìƒì„±
        run: |
          # Terraform ë³€ìˆ˜ `service_image_map`ì— í•„ìš”í•œ ì´ë¯¸ì§€ URI ë§¤í•‘
          BRANCH_NAME=$(echo "${{ github.ref_name }}" | sed 's/[^a-zA-Z0-9._-]/-/g')
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          DATE_TAG=$(date +%Y-%m-%d)
          COMBINED_TAG="${BRANCH_NAME}-${DATE_TAG}-${SHORT_SHA}"

          # SHA256 ë‹¤ì´ì œìŠ¤íŠ¸ ì¡°íšŒ ë° ì €ì¥
          CUSTOMERS_DIGEST=$(aws ecr describe-images --repository-name petclinic-dev-customers --image-ids imageTag=${COMBINED_TAG} --region us-west-2 --query 'imageDetails[0].imageDigest' --output text)
          VETS_DIGEST=$(aws ecr describe-images --repository-name petclinic-dev-vets --image-ids imageTag=${COMBINED_TAG} --region us-west-2 --query 'imageDetails[0].imageDigest' --output text)
          VISITS_DIGEST=$(aws ecr describe-images --repository-name petclinic-dev-visits --image-ids imageTag=${COMBINED_TAG} --region us-west-2 --query 'imageDetails[0].imageDigest' --output text)
          ADMIN_DIGEST=$(aws ecr describe-images --repository-name petclinic-dev-admin --image-ids imageTag=${COMBINED_TAG} --region us-west-2 --query 'imageDetails[0].imageDigest' --output text)

          echo "customers=${{ env.ECR_REGISTRY }}/petclinic-dev-customers@${CUSTOMERS_DIGEST}" >> images.properties
          echo "vets=${{ env.ECR_REGISTRY }}/petclinic-dev-vets@${VETS_DIGEST}" >> images.properties
          echo "visits=${{ env.ECR_REGISTRY }}/petclinic-dev-visits@${VISITS_DIGEST}" >> images.properties
          echo "admin=${{ env.ECR_REGISTRY }}/petclinic-dev-admin@${ADMIN_DIGEST}" >> images.properties
        shell: bash

      - name: ì´ë¯¸ì§€ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: images
          path: images.properties

      - name: Application Layer ë°°í¬ ì •ë³´ ìƒì„±
        run: |
          echo "ğŸ“ Application Layer ë°°í¬ ì •ë³´ ìƒì„±..."

          # ì´ë¯¸ì§€ íƒœê·¸ ìƒì„± (CI ì›Œí¬í”Œë¡œìš°ì™€ ë™ì¼)
          BRANCH_NAME=$(echo "${{ github.ref_name }}" | sed 's/[^a-zA-Z0-9._-]/-/g')
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          DATE_TAG=$(date +%Y-%m-%d)
          IMAGE_TAG="${BRANCH_NAME}-${DATE_TAG}-${SHORT_SHA}"

          # SHA256 ë‹¤ì´ì œìŠ¤íŠ¸ ì¡°íšŒ ë° í™˜ê²½ë³€ìˆ˜ ì„¤ì •
          CUSTOMERS_DIGEST=$(aws ecr describe-images --repository-name petclinic-dev-customers --image-ids imageTag=${IMAGE_TAG} --region us-west-2 --query 'imageDetails[0].imageDigest' --output text)
          VETS_DIGEST=$(aws ecr describe-images --repository-name petclinic-dev-vets --image-ids imageTag=${IMAGE_TAG} --region us-west-2 --query 'imageDetails[0].imageDigest' --output text)
          VISITS_DIGEST=$(aws ecr describe-images --repository-name petclinic-dev-visits --image-ids imageTag=${IMAGE_TAG} --region us-west-2 --query 'imageDetails[0].imageDigest' --output text)
          ADMIN_DIGEST=$(aws ecr describe-images --repository-name petclinic-dev-admin --image-ids imageTag=${IMAGE_TAG} --region us-west-2 --query 'imageDetails[0].imageDigest' --output text)

          echo "SERVICE_IMAGE_MAP=customers=\"${{ env.ECR_REGISTRY }}/petclinic-dev-customers@${CUSTOMERS_DIGEST}\",vets=\"${{ env.ECR_REGISTRY }}/petclinic-dev-vets@${VETS_DIGEST}\",visits=\"${{ env.ECR_REGISTRY }}/petclinic-dev-visits@${VISITS_DIGEST}\",admin=\"${{ env.ECR_REGISTRY }}/petclinic-dev-admin@${ADMIN_DIGEST}\"" >> $GITHUB_ENV
          echo "IMAGE_TAG=${IMAGE_TAG}" >> $GITHUB_ENV

          echo "âœ… ë°°í¬ ì •ë³´ ìƒì„± ì™„ë£Œ"
          echo "ì´ë¯¸ì§€ íƒœê·¸: ${IMAGE_TAG}"

      - name: ECS ì„œë¹„ìŠ¤ ìë™ ì—…ë°ì´íŠ¸
        run: |
          echo "ğŸš€ ECS ì„œë¹„ìŠ¤ ìë™ ì—…ë°ì´íŠ¸ ì‹œì‘..."

          # ECS í´ëŸ¬ìŠ¤í„° ë° ì„œë¹„ìŠ¤ ì •ë³´
          CLUSTER_NAME="petclinic-dev-cluster"
          SERVICES=("petclinic-dev-customers" "petclinic-dev-vets" "petclinic-dev-visits" "petclinic-dev-admin")

          # ê° ì„œë¹„ìŠ¤ë³„ë¡œ ì—…ë°ì´íŠ¸ ì‹¤í–‰
          for service in "${SERVICES[@]}"; do
            echo "ğŸ”„ ${service} ì„œë¹„ìŠ¤ ì—…ë°ì´íŠ¸ ì¤‘..."

            # ECS ì„œë¹„ìŠ¤ ê°•ì œ ìƒˆ ë°°í¬ ì‹¤í–‰ (íƒœìŠ¤í¬ ì •ì˜ ì—…ë°ì´íŠ¸ ì—†ì´ ê°•ì œ ì¬ë°°í¬ë§Œ)
            aws ecs update-service \
              --cluster ${CLUSTER_NAME} \
              --service ${service} \
              --force-new-deployment \
              --region ${AWS_REGION} \
              --output table

            if [ $? -eq 0 ]; then
              echo "âœ… ${service} ì„œë¹„ìŠ¤ ì—…ë°ì´íŠ¸ ìš”ì²­ ì„±ê³µ"
            else
              echo "âŒ ${service} ì„œë¹„ìŠ¤ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨"
              exit 1
            fi
          done

          echo "âœ… ëª¨ë“  ECS ì„œë¹„ìŠ¤ ì—…ë°ì´íŠ¸ ìš”ì²­ ì™„ë£Œ"
          echo "â„¹ï¸  ì°¸ê³ : ì´ ë‹¨ê³„ì—ì„œëŠ” íƒœìŠ¤í¬ ì •ì˜ë¥¼ ì—…ë°ì´íŠ¸í•˜ì§€ ì•Šê³  ê¸°ì¡´ íƒœìŠ¤í¬ ì •ì˜ë¡œ ê°•ì œ ì¬ë°°í¬ë§Œ ìˆ˜í–‰í•©ë‹ˆë‹¤."
          echo "â„¹ï¸  ì‹¤ì œ ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸ëŠ” Terraformì—ì„œ ìˆ˜í–‰ë©ë‹ˆë‹¤."

      - name: ECS ì„œë¹„ìŠ¤ ë°°í¬ ìƒíƒœ í™•ì¸
        run: |
          echo "â³ ECS ì„œë¹„ìŠ¤ ë°°í¬ ìƒíƒœ í™•ì¸ ì¤‘..."

          CLUSTER_NAME="petclinic-dev-cluster"
          SERVICES=("petclinic-dev-customers" "petclinic-dev-vets" "petclinic-dev-visits" "petclinic-dev-admin")

          # ê° ì„œë¹„ìŠ¤ì˜ ë°°í¬ ìƒíƒœ í™•ì¸
          for service in "${SERVICES[@]}"; do
            echo "ğŸ” ${service} ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸ ì¤‘..."

            # ì„œë¹„ìŠ¤ ìƒíƒœ ì¡°íšŒ
            SERVICE_STATUS=$(aws ecs describe-services \
              --cluster ${CLUSTER_NAME} \
              --services ${service} \
              --region ${AWS_REGION} \
              --query 'services[0].status' \
              --output text)

            RUNNING_COUNT=$(aws ecs describe-services \
              --cluster ${CLUSTER_NAME} \
              --services ${service} \
              --region ${AWS_REGION} \
              --query 'services[0].runningCount' \
              --output text)

            DESIRED_COUNT=$(aws ecs describe-services \
              --cluster ${CLUSTER_NAME} \
              --services ${service} \
              --region ${AWS_REGION} \
              --query 'services[0].desiredCount' \
              --output text)

            echo "ğŸ“Š ${service}: ìƒíƒœ=${SERVICE_STATUS}, ì‹¤í–‰ì¤‘=${RUNNING_COUNT}, ëª©í‘œ=${DESIRED_COUNT}"

            # ë°°í¬ ì´ë²¤íŠ¸ í™•ì¸ (ìµœê·¼ 5ê°œ)
            echo "ğŸ“‹ ${service} ìµœê·¼ ë°°í¬ ì´ë²¤íŠ¸:"
            aws ecs describe-services \
              --cluster ${CLUSTER_NAME} \
              --services ${service} \
              --region ${AWS_REGION} \
              --query 'services[0].events[:5].[createdAt,message]' \
              --output table
          done

          echo "âœ… ECS ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸ ì™„ë£Œ"

      - name: ë°°í¬ ì™„ë£Œ ëŒ€ê¸° ë° ê²€ì¦
        id: deployment-validation
        run: |
          echo "â³ ECS ì„œë¹„ìŠ¤ ì•ˆì •í™” ëŒ€ê¸° ì¤‘..."

          CLUSTER_NAME="petclinic-dev-cluster"
          SERVICES=("petclinic-dev-customers" "petclinic-dev-vets" "petclinic-dev-visits" "petclinic-dev-admin")
          FAILED_SERVICES=()

          # ë°°í¬ ì‹œì‘ ì‹œê°„ ê¸°ë¡
          DEPLOYMENT_START_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          echo "deployment_start_time=${DEPLOYMENT_START_TIME}" >> $GITHUB_OUTPUT

          # ê° ì„œë¹„ìŠ¤ê°€ ì•ˆì •í™”ë  ë•Œê¹Œì§€ ëŒ€ê¸° (ìµœëŒ€ 15ë¶„)
          for service in "${SERVICES[@]}"; do
            echo "â³ ${service} ì„œë¹„ìŠ¤ ì•ˆì •í™” ëŒ€ê¸° ì¤‘..."

            # ë°°í¬ ì „ íƒœìŠ¤í¬ ì •ì˜ ARN ì €ì¥ (ë¡¤ë°±ìš©)
            PREVIOUS_TASK_DEF=$(aws ecs describe-services \
              --cluster ${CLUSTER_NAME} \
              --services ${service} \
              --region ${AWS_REGION} \
              --query 'services[0].taskDefinition' \
              --output text)

            echo "previous_${service//-/_}_task_def=${PREVIOUS_TASK_DEF}" >> $GITHUB_OUTPUT

            # AWS CLI wait ëª…ë ¹ì–´ë¡œ ì„œë¹„ìŠ¤ ì•ˆì •í™” ëŒ€ê¸°
            timeout 900 aws ecs wait services-stable \
              --cluster ${CLUSTER_NAME} \
              --services ${service} \
              --region ${AWS_REGION}

            if [ $? -eq 0 ]; then
              echo "âœ… ${service} ì„œë¹„ìŠ¤ ì•ˆì •í™” ì™„ë£Œ"

              # í—¬ìŠ¤ì²´í¬ ê²€ì¦
              HEALTHY_TASKS=$(aws ecs describe-services \
                --cluster ${CLUSTER_NAME} \
                --services ${service} \
                --region ${AWS_REGION} \
                --query 'services[0].runningCount' \
                --output text)

              DESIRED_TASKS=$(aws ecs describe-services \
                --cluster ${CLUSTER_NAME} \
                --services ${service} \
                --region ${AWS_REGION} \
                --query 'services[0].desiredCount' \
                --output text)

              if [ "${HEALTHY_TASKS}" -eq "${DESIRED_TASKS}" ]; then
                echo "âœ… ${service} í—¬ìŠ¤ì²´í¬ í†µê³¼: ${HEALTHY_TASKS}/${DESIRED_TASKS} íƒœìŠ¤í¬ ì •ìƒ"
              else
                echo "âŒ ${service} í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨: ${HEALTHY_TASKS}/${DESIRED_TASKS} íƒœìŠ¤í¬ ì •ìƒ"
                FAILED_SERVICES+=("${service}")
              fi
            else
              echo "âŒ ${service} ì„œë¹„ìŠ¤ ì•ˆì •í™” ì‹œê°„ ì´ˆê³¼ (15ë¶„)"
              FAILED_SERVICES+=("${service}")

              # ì‹¤íŒ¨í•œ ì„œë¹„ìŠ¤ì˜ ìƒì„¸ ì •ë³´ ì¶œë ¥
              echo "ğŸ” ${service} ì„œë¹„ìŠ¤ ìƒì„¸ ì •ë³´:"
              aws ecs describe-services \
                --cluster ${CLUSTER_NAME} \
                --services ${service} \
                --region ${AWS_REGION} \
                --query 'services[0].events[:5].[createdAt,message]' \
                --output table
            fi
          done

          # ì‹¤íŒ¨í•œ ì„œë¹„ìŠ¤ê°€ ìˆëŠ”ì§€ í™•ì¸
          if [ ${#FAILED_SERVICES[@]} -gt 0 ]; then
            echo "failed_services=${FAILED_SERVICES[*]}" >> $GITHUB_OUTPUT
            echo "deployment_status=failed" >> $GITHUB_OUTPUT
            echo "âŒ ë°°í¬ ì‹¤íŒ¨: ${FAILED_SERVICES[*]}"
            exit 1
          else
            echo "deployment_status=success" >> $GITHUB_OUTPUT
            echo "ğŸ‰ ëª¨ë“  ECS ì„œë¹„ìŠ¤ ë°°í¬ ë° ì•ˆì •í™” ì™„ë£Œ!"
          fi

      - name: ë°°í¬ ì‹¤íŒ¨ ì‹œ ìë™ ë¡¤ë°±
        if: failure() && steps.deployment-validation.outputs.deployment_status == 'failed'
        run: |
          echo "ğŸ”„ ë°°í¬ ì‹¤íŒ¨ ê°ì§€ - ìë™ ë¡¤ë°± ì‹œì‘..."

          CLUSTER_NAME="petclinic-dev-cluster"
          FAILED_SERVICES="${{ steps.deployment-validation.outputs.failed_services }}"

          echo "ğŸ“‹ ë¡¤ë°± ëŒ€ìƒ ì„œë¹„ìŠ¤: ${FAILED_SERVICES}"

          # ì‹¤íŒ¨í•œ ì„œë¹„ìŠ¤ë“¤ì„ ì´ì „ íƒœìŠ¤í¬ ì •ì˜ë¡œ ë¡¤ë°±
          for service in ${FAILED_SERVICES}; do
            echo "ğŸ”„ ${service} ì„œë¹„ìŠ¤ ë¡¤ë°± ì¤‘..."

            # ì´ì „ íƒœìŠ¤í¬ ì •ì˜ ARN ê°€ì ¸ì˜¤ê¸°
            service_var="previous_${service//-/_}_task_def"
            previous_task_def=$(echo "${{ steps.deployment-validation.outputs }}" | grep "${service_var}" | cut -d'=' -f2)

            if [ -n "${previous_task_def}" ] && [ "${previous_task_def}" != "None" ]; then
              # ì´ì „ íƒœìŠ¤í¬ ì •ì˜ë¡œ ì„œë¹„ìŠ¤ ì—…ë°ì´íŠ¸
              aws ecs update-service \
                --cluster ${CLUSTER_NAME} \
                --service ${service} \
                --task-definition ${previous_task_def} \
                --region ${AWS_REGION}

              echo "âœ… ${service} ë¡¤ë°± ìš”ì²­ ì™„ë£Œ (íƒœìŠ¤í¬ ì •ì˜: ${previous_task_def})"

              # ë¡¤ë°± ì™„ë£Œ ëŒ€ê¸° (ìµœëŒ€ 10ë¶„)
              echo "â³ ${service} ë¡¤ë°± ì™„ë£Œ ëŒ€ê¸° ì¤‘..."
              timeout 600 aws ecs wait services-stable \
                --cluster ${CLUSTER_NAME} \
                --services ${service} \
                --region ${AWS_REGION}

              if [ $? -eq 0 ]; then
                echo "âœ… ${service} ë¡¤ë°± ì™„ë£Œ"
              else
                echo "âŒ ${service} ë¡¤ë°± ì‹œê°„ ì´ˆê³¼"
              fi
            else
              echo "âŒ ${service} ì´ì „ íƒœìŠ¤í¬ ì •ì˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ - ìˆ˜ë™ ë¡¤ë°± í•„ìš”"
            fi
          done

          echo "ğŸ”„ ìë™ ë¡¤ë°± í”„ë¡œì„¸ìŠ¤ ì™„ë£Œ"

      - name: ë°°í¬ ìƒíƒœ ë¡œê¹… ë° ëª¨ë‹ˆí„°ë§
        if: always()
        run: |
          echo "ğŸ“Š ë°°í¬ ìƒíƒœ ë¡œê¹… ë° ëª¨ë‹ˆí„°ë§..."

          DEPLOYMENT_STATUS="${{ steps.deployment-validation.outputs.deployment_status }}"
          DEPLOYMENT_START="${{ steps.deployment-validation.outputs.deployment_start_time }}"
          DEPLOYMENT_END=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          echo "ğŸ“‹ CI/CD íŒŒì´í”„ë¼ì¸ ìš”ì•½ ë¦¬í¬íŠ¸"
          echo "===================="
          echo "ğŸ• ì‹œì‘ ì‹œê°„: ${DEPLOYMENT_START}"
          echo "ğŸ• ì¢…ë£Œ ì‹œê°„: ${DEPLOYMENT_END}"
          echo "ğŸ“Š íŒŒì´í”„ë¼ì¸ ìƒíƒœ: ${DEPLOYMENT_STATUS}"
          echo "ğŸ·ï¸  ì´ë¯¸ì§€ íƒœê·¸: ${IMAGE_TAG}"
          echo "ğŸ”— ì»¤ë°‹ SHA: ${{ github.sha }}"
          echo "ğŸ‘¤ íŠ¸ë¦¬ê±°: ${{ github.actor }}"
          echo "ğŸŒ¿ ë¸Œëœì¹˜: ${{ github.ref_name }}"
          echo ""

          echo "ğŸ“‹ ìƒì„±ëœ ì•„í‹°íŒ©íŠ¸:"
          echo "  - Docker ì´ë¯¸ì§€ë“¤ (ECRì— í‘¸ì‹œë¨)"
          echo "  - ì´ë¯¸ì§€ ë§¤í•‘ íŒŒì¼ (images.properties)"
          echo "  - Terraform ë³€ìˆ˜ (SERVICE_IMAGE_MAP)"
          echo ""

          echo "ğŸ¯ ë‹¤ìŒ ë‹¨ê³„:"
          echo "  1. Terraformì—ì„œ ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸ ì ìš©"
          echo "  2. ECS ì„œë¹„ìŠ¤ íƒœìŠ¤í¬ ì •ì˜ ì—…ë°ì´íŠ¸"
          echo "  3. ì‹¤ì œ ë°°í¬ ë° í—¬ìŠ¤ì²´í¬ ìˆ˜í–‰"
          echo ""

          # CloudWatch ë¡œê·¸ì— CI/CD ì´ë²¤íŠ¸ ê¸°ë¡ (ì„ íƒì‚¬í•­)
          echo "ğŸ“ CloudWatch ë¡œê·¸ ê·¸ë£¹ì— CI/CD ì´ë²¤íŠ¸ ê¸°ë¡ ì¤‘..."
          aws cloudwatch put-metric-data \
            --namespace "PetClinic/CI-CD" \
            --metric-data MetricName=BuildSuccess,Value=1,Unit=Count \
            --region ${AWS_REGION} || echo "CloudWatch ë©”íŠ¸ë¦­ ì „ì†¡ ì‹¤íŒ¨ (ë¬´ì‹œ)"

          echo "âœ… CI/CD íŒŒì´í”„ë¼ì¸ ì™„ë£Œ"

      - name: ë°°í¬ ì„±ê³µ ì•Œë¦¼
        if: success()
        run: |
          echo "ğŸ‰ PetClinic ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬ ì„±ê³µ!"
          echo ""
          echo "ğŸ“‹ ë°°í¬ ìš”ì•½:"
          echo "- ì´ë¯¸ì§€ íƒœê·¸: ${IMAGE_TAG}"
          echo "- ë°°í¬ëœ ì„œë¹„ìŠ¤: customers, vets, visits, admin"
          echo "- í´ëŸ¬ìŠ¤í„°: petclinic-dev-cluster"
          echo "- ë¦¬ì „: ${AWS_REGION}"
          echo "- ì»¤ë°‹: ${{ github.sha }}"
          echo "- ë¸Œëœì¹˜: ${{ github.ref_name }}"
          echo "- ë°°í¬ì: ${{ github.actor }}"
          echo ""
          echo "ğŸ”— ì• í”Œë¦¬ì¼€ì´ì…˜ ì ‘ì†:"
          echo "- ALB ì—”ë“œí¬ì¸íŠ¸ë¥¼ í†µí•´ ì• í”Œë¦¬ì¼€ì´ì…˜ì— ì ‘ì† ê°€ëŠ¥"
          echo ""
          echo "âœ… CI/CD íŒŒì´í”„ë¼ì¸ ì™„ë£Œ: ë¹Œë“œ â†’ í‘¸ì‹œ â†’ ë°°í¬ â†’ ê²€ì¦"

          # GitHub ì´ìŠˆì— ë°°í¬ ì„±ê³µ ì½”ë©˜íŠ¸ ì¶”ê°€ (ì„ íƒì‚¬í•­)
          if [ -n "${{ github.event.pull_request.number }}" ]; then
            echo "ğŸ“ PRì— ë°°í¬ ì„±ê³µ ì•Œë¦¼ ì¶”ê°€..."
            # PR ì½”ë©˜íŠ¸ëŠ” ë³„ë„ ì•¡ì…˜ìœ¼ë¡œ ì²˜ë¦¬ ê°€ëŠ¥
          fi

      - name: ë°°í¬ ì‹¤íŒ¨ íŒ€ ì•Œë¦¼
        if: failure()
        run: |
          echo "âŒ PetClinic ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬ ì‹¤íŒ¨!"
          echo ""
          echo "ğŸš¨ ë°°í¬ ì‹¤íŒ¨ ì •ë³´:"
          echo "- ì´ë¯¸ì§€ íƒœê·¸: ${IMAGE_TAG}"
          echo "- ì‹¤íŒ¨í•œ ì„œë¹„ìŠ¤: ${{ steps.deployment-validation.outputs.failed_services }}"
          echo "- í´ëŸ¬ìŠ¤í„°: petclinic-dev-cluster"
          echo "- ë¦¬ì „: ${AWS_REGION}"
          echo "- ì»¤ë°‹: ${{ github.sha }}"
          echo "- ë¸Œëœì¹˜: ${{ github.ref_name }}"
          echo "- ë°°í¬ì: ${{ github.actor }}"
          echo "- ì›Œí¬í”Œë¡œìš° URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo ""
          echo "ğŸ”„ ìë™ ë¡¤ë°± ìƒíƒœ:"
          if [ "${{ steps.deployment-validation.outputs.deployment_status }}" == "failed" ]; then
            echo "- ìë™ ë¡¤ë°±ì´ ì‹¤í–‰ë˜ì—ˆìŠµë‹ˆë‹¤"
            echo "- ì‹¤íŒ¨í•œ ì„œë¹„ìŠ¤ë“¤ì´ ì´ì „ ë²„ì „ìœ¼ë¡œ ë³µì›ë˜ì—ˆìŠµë‹ˆë‹¤"
          else
            echo "- ë¡¤ë°±ì´ í•„ìš”í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤"
          fi
          echo ""
          echo "ğŸ” ë‹¤ìŒ ë‹¨ê³„:"
          echo "1. ì›Œí¬í”Œë¡œìš° ë¡œê·¸ë¥¼ í™•ì¸í•˜ì—¬ ì‹¤íŒ¨ ì›ì¸ì„ íŒŒì•…í•˜ì„¸ìš”"
          echo "2. ì• í”Œë¦¬ì¼€ì´ì…˜ ì½”ë“œ ë˜ëŠ” ì„¤ì •ì„ ìˆ˜ì •í•˜ì„¸ìš”"
          echo "3. ìˆ˜ì • í›„ ë‹¤ì‹œ ë°°í¬ë¥¼ ì‹œë„í•˜ì„¸ìš”"
          echo ""
          echo "ğŸ“ ê¸´ê¸‰í•œ ê²½ìš° íŒ€ ë¦¬ë”ì—ê²Œ ì—°ë½í•˜ì„¸ìš”"

          # ì‹¤íŒ¨ ì‹œ GitHub ì´ìŠˆ ìƒì„± (ì„ íƒì‚¬í•­)
          echo "ğŸ“ ë°°í¬ ì‹¤íŒ¨ ì´ìŠˆ ìƒì„± ì¤€ë¹„..."
          echo "DEPLOYMENT_FAILURE_DETAILS<<EOF" >> $GITHUB_ENV
          echo "## ğŸš¨ ë°°í¬ ì‹¤íŒ¨ ì•Œë¦¼" >> $GITHUB_ENV
          echo "" >> $GITHUB_ENV
          echo "**ë°°í¬ ì •ë³´:**" >> $GITHUB_ENV
          echo "- ì´ë¯¸ì§€ íƒœê·¸: \`${IMAGE_TAG}\`" >> $GITHUB_ENV
          echo "- ì‹¤íŒ¨í•œ ì„œë¹„ìŠ¤: \`${{ steps.deployment-validation.outputs.failed_services }}\`" >> $GITHUB_ENV
          echo "- ì»¤ë°‹: \`${{ github.sha }}\`" >> $GITHUB_ENV
          echo "- ë¸Œëœì¹˜: \`${{ github.ref_name }}\`" >> $GITHUB_ENV
          echo "- ë°°í¬ì: @${{ github.actor }}" >> $GITHUB_ENV
          echo "" >> $GITHUB_ENV
          echo "**ì›Œí¬í”Œë¡œìš°:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> $GITHUB_ENV
          echo "" >> $GITHUB_ENV
          echo "**ìë™ ë¡¤ë°±:** ì‹¤í–‰ë¨" >> $GITHUB_ENV
          echo "" >> $GITHUB_ENV
          echo "**ë‹¤ìŒ ë‹¨ê³„:**" >> $GITHUB_ENV
          echo "1. ì›Œí¬í”Œë¡œìš° ë¡œê·¸ í™•ì¸" >> $GITHUB_ENV
          echo "2. ì‹¤íŒ¨ ì›ì¸ ë¶„ì„ ë° ìˆ˜ì •" >> $GITHUB_ENV
          echo "3. ì¬ë°°í¬ ì‹œë„" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: ì•Œë¦¼ ì„¤ì •
        run: |
          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            echo "slack_enabled=true" >> $GITHUB_ENV
          else
            echo "slack_enabled=false" >> $GITHUB_ENV
          fi

      # Slack ì•Œë¦¼ (ì„ íƒì‚¬í•­ - Slack Webhook URLì´ ì„¤ì •ëœ ê²½ìš°)
      - name: Slack ì•Œë¦¼ ì „ì†¡
        if: ${{ success() && env.slack_enabled == 'true' }}
        run: |
          echo "ğŸ‰ PetClinic ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
          echo ""
          echo "ğŸ“‹ ë°°í¬ ìƒì„¸ ì •ë³´:"
          echo "ğŸ·ï¸  ì´ë¯¸ì§€ íƒœê·¸: ${{ env.IMAGE_TAG }}"
          echo "ğŸ”— ì»¤ë°‹: ${{ github.sha }}"
          echo "ğŸŒ¿ ë¸Œëœì¹˜: ${{ github.ref_name }}"
          echo "ğŸ‘¤ ë°°í¬ì: ${{ github.actor }}"
          echo "ğŸ“… ë°°í¬ ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S %Z')"
          echo ""
          echo "âœ… ë°°í¬ëœ ì„œë¹„ìŠ¤:"
          echo "  â€¢ customers-service"
          echo "  â€¢ vets-service"
          echo "  â€¢ visits-service"
          echo "  â€¢ admin-server"
          echo ""
          echo "ğŸ”— ì›Œí¬í”Œë¡œìš°: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo ""
          echo "ğŸš€ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì •ìƒì ìœ¼ë¡œ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤!"

          # JSON í˜ì´ë¡œë“œ ìƒì„±
          PAYLOAD=$(cat <<EOF
          {
            "channel": "#petclinic-alerts",
            "username": "PetClinic CI/CD",
            "icon_emoji": ":rocket:",
            "attachments": [
              {
                "color": "good",
                "title": "ğŸ‰ PetClinic ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ë°°í¬ ì„±ê³µ",
                "text": "ëª¨ë“  ì„œë¹„ìŠ¤ê°€ ì •ìƒì ìœ¼ë¡œ ë°°í¬ë˜ê³  ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤.",
                "fields": [
                  {
                    "title": "ì´ë¯¸ì§€ íƒœê·¸",
                    "value": "${{ env.IMAGE_TAG }}",
                    "short": true
                  },
                  {
                    "title": "ì»¤ë°‹",
                    "value": "${{ github.sha }}",
                    "short": true
                  },
                  {
                    "title": "ë¸Œëœì¹˜",
                    "value": "${{ github.ref_name }}",
                    "short": false
                  },
                  {
                    "title": "ë°°í¬ì",
                    "value": "${{ github.actor }}",
                    "short": true
                  },
                  {
                    "title": "ë°°í¬ëœ ì„œë¹„ìŠ¤",
                    "value": "customers, vets, visits, admin",
                    "short": false
                  }
                ],
                "actions": [
                  {
                    "type": "button",
                    "text": "ì›Œí¬í”Œë¡œìš° ë³´ê¸°",
                    "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                  },
                  {
                    "type": "button",
                    "text": "ì»¤ë°‹ ë³´ê¸°",
                    "url": "${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}"
                  }
                ],
                "footer": "GitHub Actions CI/CD",
                "footer_icon": "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png",
                "ts": $(date +%s)
              }
            ]
          }
          EOF
          )

          # Slackìœ¼ë¡œ ë©”ì‹œì§€ ì „ì†¡
          curl -X POST -H 'Content-type: application/json' -d "$PAYLOAD" ${{ secrets.SLACK_WEBHOOK_URL }}

