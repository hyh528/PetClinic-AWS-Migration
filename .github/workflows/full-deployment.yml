name: Full System Deployment

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'dev'
        type: choice
        options:
        - dev
        - staging
        - prod
      deployment_type:
        description: 'Deployment type'
        required: true
        default: 'infrastructure_and_apps'
        type: choice
        options:
        - infrastructure_only
        - applications_only
        - infrastructure_and_apps
        - lambda_only
      force_rebuild:
        description: 'Force rebuild all components'
        required: false
        default: false
        type: boolean

env:
  AWS_REGION: 'ap-northeast-1'  # ÎèÑÏøÑ Î¶¨Ï†ÑÏúºÎ°ú Î≥ÄÍ≤Ω

jobs:
  # Î∞∞Ìè¨ Í≥ÑÌöç ÏàòÎ¶Ω
  deployment-plan:
    name: Create Deployment Plan
    runs-on: ubuntu-latest
    outputs:
      deploy_infrastructure: ${{ steps.plan.outputs.deploy_infrastructure }}
      deploy_lambda: ${{ steps.plan.outputs.deploy_lambda }}
      deploy_applications: ${{ steps.plan.outputs.deploy_applications }}
      environment: ${{ steps.plan.outputs.environment }}
    
    steps:
      - name: Create Deployment Plan
        id: plan
        run: |
          DEPLOYMENT_TYPE="${{ github.event.inputs.deployment_type }}"
          ENVIRONMENT="${{ github.event.inputs.environment }}"
          
          echo "üéØ Creating deployment plan for: ${ENVIRONMENT}"
          echo "üìã Deployment type: ${DEPLOYMENT_TYPE}"
          
          # Î∞∞Ìè¨ ÌîåÎûòÍ∑∏ ÏÑ§Ï†ï
          case "${DEPLOYMENT_TYPE}" in
            "infrastructure_only")
              echo "deploy_infrastructure=true" >> $GITHUB_OUTPUT
              echo "deploy_lambda=false" >> $GITHUB_OUTPUT
              echo "deploy_applications=false" >> $GITHUB_OUTPUT
              ;;
            "applications_only")
              echo "deploy_infrastructure=false" >> $GITHUB_OUTPUT
              echo "deploy_lambda=false" >> $GITHUB_OUTPUT
              echo "deploy_applications=true" >> $GITHUB_OUTPUT
              ;;
            "lambda_only")
              echo "deploy_infrastructure=false" >> $GITHUB_OUTPUT
              echo "deploy_lambda=true" >> $GITHUB_OUTPUT
              echo "deploy_applications=false" >> $GITHUB_OUTPUT
              ;;
            "infrastructure_and_apps")
              echo "deploy_infrastructure=true" >> $GITHUB_OUTPUT
              echo "deploy_lambda=true" >> $GITHUB_OUTPUT
              echo "deploy_applications=true" >> $GITHUB_OUTPUT
              ;;
          esac
          
          echo "environment=${ENVIRONMENT}" >> $GITHUB_OUTPUT
          
          echo "‚úÖ Deployment plan created"

  # 1Îã®Í≥Ñ: Terraform Ïù∏ÌîÑÎùº Î∞∞Ìè¨
  deploy-infrastructure:
    name: Deploy Infrastructure
    needs: deployment-plan
    if: needs.deployment-plan.outputs.deploy_infrastructure == 'true'
    uses: ./.github/workflows/terraform-infrastructure.yml
    with:
      environment: ${{ needs.deployment-plan.outputs.environment }}
      action: apply
    secrets: inherit

  # 2Îã®Í≥Ñ: Lambda Ìï®Ïàò Î∞∞Ìè¨
  deploy-lambda:
    name: Deploy Lambda Functions
    needs: [deployment-plan, deploy-infrastructure]
    if: always() && needs.deployment-plan.outputs.deploy_lambda == 'true' && (needs.deploy-infrastructure.result == 'success' || needs.deploy-infrastructure.result == 'skipped')
    uses: ./.github/workflows/lambda-deployment.yml
    with:
      environment: ${{ needs.deployment-plan.outputs.environment }}
    secrets: inherit

  # 3Îã®Í≥Ñ: Spring Boot Ïï†ÌîåÎ¶¨ÏºÄÏù¥ÏÖò Î∞∞Ìè¨
  deploy-applications:
    name: Deploy Applications
    needs: [deployment-plan, deploy-infrastructure, deploy-lambda]
    if: always() && needs.deployment-plan.outputs.deploy_applications == 'true' && (needs.deploy-infrastructure.result == 'success' || needs.deploy-infrastructure.result == 'skipped')
    uses: ./.github/workflows/application-deployment.yml
    with:
      environment: ${{ needs.deployment-plan.outputs.environment }}
      services: 'all'
    secrets: inherit

  # 4Îã®Í≥Ñ: ÌÜµÌï© ÌÖåÏä§Ìä∏ Ïã§Ìñâ
  integration-tests:
    name: Integration Tests
    needs: [deployment-plan, deploy-infrastructure, deploy-lambda, deploy-applications]
    if: always() && (needs.deploy-infrastructure.result == 'success' || needs.deploy-infrastructure.result == 'skipped')
    uses: ./.github/workflows/terraform-integration-tests.yml
    with:
      environment: ${{ needs.deployment-plan.outputs.environment }}
      skip-deployment: false
      test-suite: 'all'
    secrets: inherit

  # 5Îã®Í≥Ñ: Î∞∞Ìè¨ ÌõÑ Í≤ÄÏ¶ù (Í∏∞Ï°¥ Í≤ÄÏ¶ù + ÌÖåÏä§Ìä∏ Í≤∞Í≥º ÌÜµÌï©)
  post-deployment-verification:
    name: Post-Deployment Verification
    runs-on: ubuntu-latest
    needs: [deployment-plan, deploy-infrastructure, deploy-lambda, deploy-applications, integration-tests]
    if: always()
    environment: 
      name: ${{ needs.deployment-plan.outputs.environment }}
      url: https://console.aws.amazon.com/
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Verify Infrastructure
        if: needs.deployment-plan.outputs.deploy_infrastructure == 'true'
        run: |
          ENVIRONMENT="${{ needs.deployment-plan.outputs.environment }}"
          
          echo "üîç Verifying infrastructure components..."
          
          # VPC ÌôïÏù∏
          VPC_ID=$(aws ec2 describe-vpcs \
            --filters "Name=tag:Name,Values=petclinic-vpc-${ENVIRONMENT}" \
            --query 'Vpcs[0].VpcId' \
            --output text \
            --region ${{ env.AWS_REGION }})
          
          if [ "${VPC_ID}" != "None" ] && [ "${VPC_ID}" != "" ]; then
            echo "‚úÖ VPC found: ${VPC_ID}"
          else
            echo "‚ùå VPC not found"
            exit 1
          fi
          
          # ECS ÌÅ¥Îü¨Ïä§ÌÑ∞ ÌôïÏù∏
          CLUSTER_STATUS=$(aws ecs describe-clusters \
            --clusters "petclinic-cluster-${ENVIRONMENT}" \
            --query 'clusters[0].status' \
            --output text \
            --region ${{ env.AWS_REGION }})
          
          if [ "${CLUSTER_STATUS}" = "ACTIVE" ]; then
            echo "‚úÖ ECS Cluster is active"
          else
            echo "‚ùå ECS Cluster not active: ${CLUSTER_STATUS}"
            exit 1
          fi
          
          # Aurora ÌÅ¥Îü¨Ïä§ÌÑ∞ ÌôïÏù∏
          DB_STATUS=$(aws rds describe-db-clusters \
            --db-cluster-identifier "petclinic-aurora-${ENVIRONMENT}" \
            --query 'DBClusters[0].Status' \
            --output text \
            --region ${{ env.AWS_REGION }})
          
          if [ "${DB_STATUS}" = "available" ]; then
            echo "‚úÖ Aurora cluster is available"
          else
            echo "‚ö†Ô∏è Aurora cluster status: ${DB_STATUS}"
          fi

      - name: Verify Lambda Functions
        if: needs.deployment-plan.outputs.deploy_lambda == 'true'
        run: |
          ENVIRONMENT="${{ needs.deployment-plan.outputs.environment }}"
          FUNCTION_NAME="petclinic-genai-service-${ENVIRONMENT}"
          
          echo "üîç Verifying Lambda function: ${FUNCTION_NAME}"
          
          # Lambda Ìï®Ïàò ÏÉÅÌÉú ÌôïÏù∏
          FUNCTION_STATE=$(aws lambda get-function \
            --function-name "${FUNCTION_NAME}" \
            --query 'Configuration.State' \
            --output text \
            --region ${{ env.AWS_REGION }})
          
          if [ "${FUNCTION_STATE}" = "Active" ]; then
            echo "‚úÖ Lambda function is active"
            
            # Í∞ÑÎã®Ìïú ÌÖåÏä§Ìä∏ Ìò∏Ï∂ú
            TEST_PAYLOAD='{"httpMethod":"GET","path":"/health"}'
            aws lambda invoke \
              --function-name "${FUNCTION_NAME}:LIVE" \
              --payload "${TEST_PAYLOAD}" \
              --region ${{ env.AWS_REGION }} \
              response.json
            
            if [ $? -eq 0 ]; then
              echo "‚úÖ Lambda function test successful"
            else
              echo "‚ö†Ô∏è Lambda function test failed"
            fi
          else
            echo "‚ùå Lambda function not active: ${FUNCTION_STATE}"
            exit 1
          fi

      - name: Verify ECS Services
        if: needs.deployment-plan.outputs.deploy_applications == 'true'
        run: |
          ENVIRONMENT="${{ needs.deployment-plan.outputs.environment }}"
          CLUSTER_NAME="petclinic-cluster-${ENVIRONMENT}"
          
          echo "üîç Verifying ECS services..."
          
          SERVICES=("customers" "vets" "visits" "admin" "api-gateway")
          
          for service in "${SERVICES[@]}"; do
            SERVICE_NAME="petclinic-${service}-${ENVIRONMENT}"
            
            SERVICE_STATUS=$(aws ecs describe-services \
              --cluster "${CLUSTER_NAME}" \
              --services "${SERVICE_NAME}" \
              --query 'services[0].status' \
              --output text \
              --region ${{ env.AWS_REGION }} 2>/dev/null)
            
            RUNNING_COUNT=$(aws ecs describe-services \
              --cluster "${CLUSTER_NAME}" \
              --services "${SERVICE_NAME}" \
              --query 'services[0].runningCount' \
              --output text \
              --region ${{ env.AWS_REGION }} 2>/dev/null)
            
            DESIRED_COUNT=$(aws ecs describe-services \
              --cluster "${CLUSTER_NAME}" \
              --services "${SERVICE_NAME}" \
              --query 'services[0].desiredCount' \
              --output text \
              --region ${{ env.AWS_REGION }} 2>/dev/null)
            
            if [ "${SERVICE_STATUS}" = "ACTIVE" ] && [ "${RUNNING_COUNT}" = "${DESIRED_COUNT}" ]; then
              echo "‚úÖ ${service} service: ${RUNNING_COUNT}/${DESIRED_COUNT} tasks running"
            else
              echo "‚ö†Ô∏è ${service} service: Status=${SERVICE_STATUS}, Tasks=${RUNNING_COUNT}/${DESIRED_COUNT}"
            fi
          done

      - name: Test API Gateway
        run: |
          ENVIRONMENT="${{ needs.deployment-plan.outputs.environment }}"
          
          echo "üîç Testing API Gateway endpoints..."
          
          # API Gateway URL Í∞ÄÏ†∏Ïò§Í∏∞
          API_ID=$(aws apigateway get-rest-apis \
            --query "items[?name=='petclinic-api-${ENVIRONMENT}'].id" \
            --output text \
            --region ${{ env.AWS_REGION }})
          
          if [ "${API_ID}" != "" ] && [ "${API_ID}" != "None" ]; then
            API_URL="https://${API_ID}.execute-api.${{ env.AWS_REGION }}.amazonaws.com/dev"
            echo "‚úÖ API Gateway found: ${API_URL}"
            
            # Ìó¨Ïä§Ï≤¥ÌÅ¨ ÏóîÎìúÌè¨Ïù∏Ìä∏ ÌÖåÏä§Ìä∏
            echo "Testing health endpoints..."
            
            ENDPOINTS=("/api/customers/actuator/health" "/api/vets/actuator/health" "/api/visits/actuator/health")
            
            for endpoint in "${ENDPOINTS[@]}"; do
              HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "${API_URL}${endpoint}" || echo "000")
              
              if [ "${HTTP_STATUS}" = "200" ]; then
                echo "‚úÖ ${endpoint}: HTTP ${HTTP_STATUS}"
              else
                echo "‚ö†Ô∏è ${endpoint}: HTTP ${HTTP_STATUS}"
              fi
            done
          else
            echo "‚ö†Ô∏è API Gateway not found"
          fi

      - name: Generate Deployment Report
        run: |
          echo "üìä Full System Deployment Report"
          echo "================================="
          echo "Environment: ${{ needs.deployment-plan.outputs.environment }}"
          echo "Deployment Type: ${{ github.event.inputs.deployment_type }}"
          echo "Timestamp: $(date -u)"
          echo "Commit: ${{ github.sha }}"
          echo ""
          echo "Component Status:"
          echo "- Infrastructure: ${{ needs.deploy-infrastructure.result || 'skipped' }}"
          echo "- Lambda Functions: ${{ needs.deploy-lambda.result || 'skipped' }}"
          echo "- Applications: ${{ needs.deploy-applications.result || 'skipped' }}"
          echo "- Integration Tests: ${{ needs.integration-tests.result || 'skipped' }}"
          echo ""
          
          # ÌÜµÌï© ÌÖåÏä§Ìä∏ Í≤∞Í≥º ÌëúÏãú
          if [ "${{ needs.integration-tests.result }}" = "success" ]; then
            echo "‚úÖ Integration Tests: ${{ needs.integration-tests.outputs.test-results }}"
          elif [ "${{ needs.integration-tests.result }}" = "failure" ]; then
            echo "‚ùå Integration Tests: ${{ needs.integration-tests.outputs.test-results }}"
          fi
          echo ""
          
          # Ï†ÑÏ≤¥ Î∞∞Ìè¨ ÏÑ±Í≥µ Ïó¨Î∂Ä ÌåêÎã®
          OVERALL_SUCCESS=true
          
          if [ "${{ needs.deployment-plan.outputs.deploy_infrastructure }}" = "true" ] && [ "${{ needs.deploy-infrastructure.result }}" != "success" ]; then
            OVERALL_SUCCESS=false
          fi
          
          if [ "${{ needs.deployment-plan.outputs.deploy_lambda }}" = "true" ] && [ "${{ needs.deploy-lambda.result }}" != "success" ]; then
            OVERALL_SUCCESS=false
          fi
          
          if [ "${{ needs.deployment-plan.outputs.deploy_applications }}" = "true" ] && [ "${{ needs.deploy-applications.result }}" != "success" ]; then
            OVERALL_SUCCESS=false
          fi
          
          # ÌÜµÌï© ÌÖåÏä§Ìä∏ Ïã§Ìå®ÎèÑ Ï†ÑÏ≤¥ Ïã§Ìå®Î°ú Í∞ÑÏ£º
          if [ "${{ needs.integration-tests.result }}" = "failure" ]; then
            OVERALL_SUCCESS=false
          fi
          
          if [ "${OVERALL_SUCCESS}" = "true" ]; then
            echo "üéâ Overall Status: SUCCESS"
            echo "All requested components deployed and tested successfully!"
          else
            echo "‚ùå Overall Status: FAILED"
            echo "Some components failed to deploy or pass tests. Check the logs above."
            exit 1
          fi