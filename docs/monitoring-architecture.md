# 모니터링 아키텍처 개요

## 📊 전체 모니터링 구조

```
사용자 요청 흐름
    ↓
┌─────────────────────────────────────────────────────────────┐
│  🌐 Route 53 (DNS 헬스체크)                                   │
│  🌐 CloudFront (접속 로그, 캐시 통계)                          │
│  🛡️ WAF (공격 차단 통계)                                      │
│  ⚖️ ALB (요청 수, 응답 시간, HTTP 상태 코드)                     │
│  🐳 ECS Services (CPU, 메모리, 작업 수)                        │
│  💾 RDS (연결 수, 쿼리 성능)                                  │
│  🔄 ElastiCache (캐시 적중률)                                 │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
            ┌─────────────────────┐
            │  📊 CloudWatch      │
            │  (통합 모니터링)     │
            └─────────┬───────────┘
                      │
            ┌─────────┴───────────┐
            ┌─────────┴───────────┐
            │ 📈 대시보드         │
            │ (시각화)           │
            └─────────────────────┘
            │ 🚨 알람 + SNS       │
            │ (알림)             │
            └─────────────────────┘
```

## 🔍 모니터링 컴포넌트 상세

### 1. 데이터 수집 계층
```
┌─────────────────────────────────────────────────────────────┐
│  📡 메트릭 수집                                              │
├─────────────────────────────────────────────────────────────┤
│  • AWS/ECS: CPUUtilization, MemoryUtilization              │
│  • AWS/ApplicationELB: RequestCount, TargetResponseTime     │
│  • AWS/RDS: CPUUtilization, DatabaseConnections             │
│  • AWS/ElastiCache: CacheHits, CacheMisses                  │
│  • AWS/WAFV2: AllowedRequests, BlockedRequests              │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│  📝 로그 수집                                                │
├─────────────────────────────────────────────────────────────┤
│  • /ecs/petclinic-dev-*/ : 애플리케이션 로그                 │
│  • /aws/rds/instance/error : DB 에러 로그                    │
│  • /aws/rds/instance/slowquery : 느린 쿼리 로그              │
│  • ALB Access Logs : 요청/응답 로그                         │
└─────────────────────────────────────────────────────────────┘
```

### 2. 분석 및 시각화 계층
```
┌─────────────────────────────────────────────────────────────┐
│  📊 CloudWatch 대시보드 (6개 위젯)                           │
├─────────────────────────────────────────────────────────────┤
│  • ECS CPU/메모리 사용률                                    │
│  • ALB 요청 수 및 HTTP 상태 코드                             │
│  • RDS CPU/연결 수                                          │
│  • ElastiCache 캐시 적중률                                  │
│  • Container Insights (작업별 상세)                          │
│  • WAF 요청 통계                                            │
└─────────────────────────────────────────────────────────────┘
```

### 3. 알림 및 대응 계층
```
┌─────────────────────────────────────────────────────────────┐
│  🚨 알람 시스템 (20개 알람)                                 │
├─────────────────────────────────────────────────────────────┤
│  • ecs-cpu-high: CPU > 80% (5분간 2회)                      │
│  • ecs-memory-high: 메모리 > 80% (5분간 2회)                │
│  • alb-5xx-errors: 5XX > 10개 (5분간 1회)                   │
│  • alb-response-time: 응답시간 > 3초 (5분간 2회)             │
│  • rds-cpu-high: DB CPU > 80% (10분간 2회)                  │
│  • rds-connections: DB 연결 > 80 (5분간 2회)                │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│  📢 알림 채널                                               │
├─────────────────────────────────────────────────────────────┤
│  • SNS Topic: petclinic-dev-alerts                          │
│  • 이메일/SMS/Slack 알림                                     │
│  • OpsGenie/PagerDuty 연동 가능                              │
└─────────────────────────────────────────────────────────────┘
```

## 🏗️ 아키텍처 계층별 모니터링

### Layer 07 (Application) - 실시간 모니터링
```
ECS 서비스별 즉각적인 건강 상태
├── ALB 메트릭 (요청/응답)
├── ECS 메트릭 (CPU/메모리)
└── 서비스별 대시보드 위젯
```

### Layer 10 (Monitoring) - 통합 모니터링
```
전체 시스템 통합 모니터링
├── 모든 레이어 메트릭 수집
├── 통합 대시보드
├── 알람 관리 및 자동화
└── 비용 최적화
```

## 💰 비용 구조 (월 예상)
```
┌─────────────────────────────────────────────────────────────┐
│  CloudWatch 비용 분석                                       │
├─────────────────────────────────────────────────────────────┤
│  • 기본 메트릭: 무료                                        │
│  • 대시보드 (1개): 무료                                     │
│  • 알람 (20개): $2.00                                       │
│  • 로그 수집 (5GB): $2.50                                   │
│  • 로그 스토리지 (10GB): $0.30                              │
│  • Container Insights (6개): $3.00                          │
├─────────────────────────────────────────────────────────────┤
│  총계: $7.80/월                                             │
│  (WAF 로깅 제거로 $53/월 절감)                              │
└─────────────────────────────────────────────────────────────┘
```

## 🔧 주요 모니터링 도구

### CloudWatch Logs Insights
```sql
-- 에러 로그 필터링
fields @timestamp, @message
| filter @message like /ERROR/
| sort @timestamp desc

-- 느린 응답 시간 분석
fields @timestamp, @message, response_time
| filter response_time > 3000
| sort response_time desc
```

### Container Insights
```
ECS 작업별 상세 메트릭
├── CPU/Memory (작업별)
├── 네트워크 I/O
├── 디스크 I/O
└── 로그 메트릭 필터
```

### X-Ray (분산 추적)
```
요청 흐름 추적
├── 서비스간 호출 관계
├── 병목 지점 식별
└── 성능 분석
```

## 📋 모니터링 체크리스트

### 일일 점검
- [ ] 대시보드 CPU/메모리 사용률 확인
- [ ] ALB 요청 수 및 에러율 확인
- [ ] RDS 연결 수 및 성능 확인
- [ ] 활성 알람 없음 확인

### 주간 리뷰
- [ ] 로그 패턴 분석 (에러 추이)
- [ ] 비용 최적화 검토
- [ ] 알람 임계값 조정

### 월간 보고
- [ ] 시스템 성능 리포트
- [ ] 장애 대응 시간 분석
- [ ] 모니터링 개선사항 도출

---

**모니터링 철학**: "예측하고 예방하라"
- 🚨 **반응적 모니터링**: 문제가 발생한 후 대응
- 🎯 **능동적 모니터링**: 문제가 발생하기 전에 예측
- 📊 **지속적 개선**: 모니터링 데이터를 통한 시스템 최적화