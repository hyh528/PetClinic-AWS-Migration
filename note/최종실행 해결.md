# Terraform Plan 최종 실행 해결 과정 요약 (2025-10-15)

## 목표
`terraform/envs/dev/application` 디렉터리에서 `terraform init` 및 `terraform plan` 명령어를 성공적으로 실행시키는 것.

## 최종 요약
`terraform init`부터 `terraform plan`까지 발생하는 여러 오류를 단계적으로 해결했습니다. 주요 오류는 모듈 중복 선언, 모듈 경로 오타, 원격 상태(remote state) 설정 오류, 그리고 모듈 변수 누락이었습니다. 각 문제를 진단하고, 초심자가 이해하기 쉬운 방식으로 원인을 설명하며 코드를 수정하여 최종적으로 `terraform plan` 실행에 성공했습니다.

---

## 오류 해결 과정 상세

<details>
<summary><strong>1. `terraform init` 실패: 모듈 중복 선언 및 경로 오류</strong></summary>

- **오류 1: `Duplicate module call`**
    - **원인**: `main.tf` 파일에 다른 `.tf` 파일(`cloudmap.tf`, `ecr.tf`)에 이미 선언된 모듈이 중복으로 포함되어 있었습니다.
    - **해결**: `main.tf`의 중복된 내용을 삭제했습니다.

- **오류 2: `Unreadable module directory`**
    - **원인**: `ecs` 모듈을 참조해야 하는데, 실제 디렉터리 이름이 `esc`로 오타가 있었습니다.
    - **해결**: `terraform/modules/esc` 디렉터리 이름을 `terraform/modules/ecs`로 변경했습니다.
</details>

<details>
<summary><strong>2. `terraform plan` 실패: 선언되지 않은 모듈 및 변수 오류</strong></summary>

- **오류 3: `Reference to undeclared module`**
    - **원인**: `cloudmap.tf`에서 VPC ID를 가져오기 위해 `module.vpc.vpc_id`를 사용했지만, `application` 레이어에는 `vpc` 모듈이 선언되어 있지 않았습니다.
    - **해결**: `network` 레이어의 원격 상태 결과물을 사용하도록 `data.terraform_remote_state.network.outputs.vpc_id`로 수정했습니다.

- **오류 4: `Value for undeclared variable` (경고)**
    - **원인**: `dev.tfvars` 파일에는 `database_state_profile` 변수가 있었지만, `variables.tf` 파일에서는 해당 변수 선언이 주석 처리되어 있었습니다.
    - **해결**: `variables.tf` 파일에서 `database_state_profile` 변수의 주석을 제거하여 활성화했습니다.
</details>

<details>
<summary><strong>3. `terraform plan` 실패: 원격 상태(Remote State) 오류</strong></summary>

- **오류 5: `Unable to find remote state`**
    - **원인 1 (잘못된 참조)**: `data.tf`에서 `security` 레이어의 상태를 조회할 때, 담당자가 `hwigwon`임에도 불구하고 `yeonghyeon`의 프로필과 경로로 잘못 설정되어 있었습니다.
    - **해결 1**: `security` 원격 상태 블록의 `key`와 `profile`을 `hwigwon`의 정보 (`var.security_state_profile`)로 올바르게 수정했습니다.
    - **원인 2 (근본 원인)**: `network`와 `security` 레이어가 `apply`된 적이 없어 S3 버킷에 상태 파일이 실제로 존재하지 않았습니다.
    - **해결 2**: 담당자가 각 레이어를 `apply`하여 S3 버킷에 상태 파일을 생성했습니다.

</details>

<details>
<summary><strong>4. `terraform plan` 실패: 모듈 입력 변수 누락</strong></summary>

- **오류 6: `expected length of name to be in the range (1 - 1024), got`**
    - **원인**: `cloudmap` 모듈에 필수 입력 변수인 `namespace_name`이 전달되지 않았습니다. (1번 오류 해결 시 `main.tf`에서 삭제됨)
    - **해결**: `cloudmap.tf`의 `cloudmap` 모듈 호출부에 `namespace_name = "petclinic.test"` 코드를 추가했습니다.
</details>

---

## 최종 수정 완료된 파일

아래는 모든 오류를 해결한 후의 최종 파일 내용입니다.

<details>
<summary><b>📄 terraform/envs/dev/application/main.tf</b></summary>

```terraform
# 배포할 서비스 목록을 map으로 정의
locals {
  ecs_services = {
    "customers-service" = {
      container_port = 8080
      image_uri      = "${module.ecr.repository_urls["customers-service"]}:latest"
      priority       = 100 # 리스너 규칙 우선순위 (겹치면 안 됨)
    },
    "vets-service" = {
      container_port = 8080
      image_uri      = "${module.ecr.repository_urls["vets-service"]}:latest"
      priority       = 110
    },
    "visits-service" = {
      container_port = 8080
      image_uri      = "${module.ecr.repository_urls["visits-service"]}:latest"
      priority       = 120
    }
  }
}

# for_each를 사용하여 서비스별로 ecs 모듈 호출
module "ecs" {
  for_each = local.ecs_services
  source   = "../../../modules/ecs"

  # --- 공유 리소스 값 전달 ---
  aws_region                  = var.aws_region
  vpc_id                      = data.terraform_remote_state.network.outputs.vpc_id
  private_subnet_ids          = values(data.terraform_remote_state.network.outputs.private_app_subnet_ids)
  ecs_service_sg_id           = data.terraform_remote_state.security.outputs.app_security_group_id
  cluster_id                  = aws_ecs_cluster.main.id
  ecs_task_execution_role_arn = aws_iam_role.ecs_task_execution_role.arn
  listener_arn                = aws_lb_listener.http.arn

  # --- 서비스별 값 전달 ---
  service_name      = each.key
  image_uri         = each.value.image_uri
  container_port    = each.value.container_port
  listener_priority = each.value.priority


  # 각 서비스의 이름(each.key)에 해당하는 Cloud Map 서비스의 ARN을 전달
  cloudmap_service_arn = module.cloudmap.service_arns[each.key]
}
```
</details>

<details>
<summary><b>📄 terraform/envs/dev/application/cloudmap.tf</b></summary>

```terraform
module "cloudmap" {
  # 모듈 경로
  source = "../../../modules/cloudmap"

  namespace_name = "petclinic.test"

  # 사용할 VPC
  vpc_id = data.terraform_remote_state.network.outputs.vpc_id

  #Cloudmap에 등록할 마이크로 서비스 목록
  service_name_map = {
    "customers-service" = "customer service"
    "vets-service"      = "vets-service"
    "visits-service"    = "visits-service"

  }
  
  tags = {
    Environment = "dev"
    Project     = "PetClinic"
  }
} #Cloud Map 모듈
```
</details>

<details>
<summary><b>📄 terraform/envs/dev/application/data.tf</b></summary>

```terraform
data "terraform_remote_state" "network" {
  backend = "s3"
  config = {
    bucket  = "petclinic-tfstate-team-jungsu-kopo"
    key     = "dev/yeonghyeon/network/terraform.tfstate"
    region  = var.aws_region
    profile = var.network_state_profile
  }
} # network 레이어 결과

data "terraform_remote_state" "security" {
  backend = "s3"
  config = {
    bucket  = "petclinic-tfstate-team-jungsu-kopo"
    key     = "dev/hwigwon/security/terraform.tfstate"
    region  = var.aws_region
    profile = var.security_state_profile
  }
} # security 레이어 결과
```
</details>

<details>
<summary><b>📄 terraform/envs/dev/application/variables.tf</b></summary>

```terraform
variable "aws_profile" {
  description = "인증용 AWS 프로필"
  type        = string
}

variable "aws_region" {
  description = "리소스용 AWS 리전"
  type        = string
}
variable "network_state_profile" {
  description = "네트워크 상태 파일 접근용 AWS 프로필"
  type        = string
}

variable "security_state_profile" {
  description = "보안 상태 파일 접근용 AWS 프로필"
  type        = string
}

variable "database_state_profile" {
  description = "DB 상태 파일 접근용 AWS 프로필"
  type        = string
}
```
</details>
