# 2025년 11월 03일 작업일지

## 1. `context_path` 동적 설정으로 리팩토링

### 1.1. 문제 진단
- `terraform/envs/dev/application/ecs.tf` 파일에서 `context_path`가 하드코딩되어 있어, 각 서비스의 실제 경로와 불일치할 가능성이 존재했습니다.

### 1.2. 해결 방안
- 각 서비스의 `context_path`를 AWS Parameter Store에서 동적으로 가져오도록 `ecs.tf` 파일을 수정했습니다.
- `data "aws_ssm_parameter" "service_context_paths"` 블록을 추가하여 각 서비스의 `server.servlet.context-path` 파라미터를 조회하도록 변경했습니다.
- `locals.ecs_services` 맵이 이 `data` 블록의 결과를 참조하여 `context_path`를 동적으로 할당하도록 수정했습니다.

---

## 2. `customers-service` 접속 오류 해결

### 2.1. 1차 오류: `ContextPath must start with '/'`
- **원인**: 애플리케이션 로그 분석 결과, Parameter Store에 저장된 `context-path` 값의 형식이 잘못되어 애플리케이션 시작에 실패했습니다.
- **해결**: Parameter Store의 `/petclinic/dev/customers/server.servlet.context-path` 파라미터 값을 `/customer`와 같이 `/`로 시작하고 `/`로 끝나지 않는 올바른 형식으로 수정하도록 안내했습니다.

### 2.2. 2차 오류: 대상 그룹 헬스 체크 경로 이중 슬래시(`//`) 문제
- **원인**: `terraform/modules/ecs/main.tf`의 헬스 체크 경로가 `path = "/${var.context_path}/actuator/health"`로 되어 있어, Parameter Store의 `/customer` 값과 합쳐지면서 `//customer/actuator/health`가 되는 문제가 있었습니다.
- **해결**: `path = "${var.context_path}/actuator/health"`로 수정하여 하드코딩된 슬래시를 제거했습니다.

### 2.3. 3차 오류: `Request time out` (Unhealthy)
- **원인**: 보안 그룹 설정 오류. `terraform/modules/sg/main.tf` 파일에서 ECS 서비스 보안 그룹의 인바운드 규칙이 `8080` 포트만 허용하도록 하드코딩되어 있어, 다른 포트를 사용하는 서비스의 헬스 체크가 차단되었습니다.
- **해결**: 해당 인바운드 규칙을 `from_port = 0`, `to_port = 0`으로 변경하여 ALB로부터 오는 모든 TCP 트래픽을 허용하도록 수정했습니다.

### 2.4. 4차 오류: `404 Not Found` (헬스 체크는 정상)
- **원인**: ALB와 ECS 서비스 간 통신은 정상이지만, 사용자가 접속하려는 최종 엔드포인트 URL이 잘못되었습니다.
- **해결**: `customers-service`의 소스 코드(`OwnerResource.java`)를 직접 분석하여, 올바른 엔드포인트가 `http://<ALB-DNS>/customers/owners`임을 확인하고 안내했습니다.

---

## 3. 전체 서비스 엔드포인트 URL 정리

- Terraform의 ALB 리스너 규칙과 각 서비스의 소스 코드를 종합적으로 분석하여, 전체 서비스의 최종 접속 URL을 정리했습니다.
- **Customer Service:** `http://petclinic-main-alb-1913720731.ap-northeast-2.elb.amazonaws.com/customers/owners`
- **Vets Service:** `http://petclinic-main-alb-1913720731.ap-northeast-2.elb.amazonaws.com/vets/vets`
- **Visits Service:** `http://petclinic-main-alb-1913720731.ap-northeast-2.elb.amazonaws.com/visits/pets/visits?petId=1`
- **Admin Server:** `http://petclinic-main-alb-1913720731.ap-northeast-2.elb.amazonaws.com/admin`

---

## 4. `vets`, `visits`, `admin` 서비스 오류 분석 및 해결

### 4.1. 문제 진단
- **`vets`, `visits` ("Whitelabel Error"):** 데이터베이스 연결 실패로 추정.
- **`admin` ("Cannot route request" / 404 Health Check Failed):** 서비스 디스커버리 문제 및 `context-path` 설정 불일치로 추정.

### 4.2. 근본 원인 발견: IAM 권한 누락
- 모든 문제의 근본 원인은 **ECS Task Role의 IAM 권한 부족**이었습니다.
- `application` 스택이 `security` 스택의 `ecs_task_role_arn` 출력을 참조하려 했으나, `security` 스택의 `outputs.tf`에 해당 출력이 정의되어 있지 않았습니다.
- 이로 인해 모든 ECS 서비스가 데이터베이스 정보(Secrets Manager, Parameter Store)에 접근할 권한이 없어 시작에 실패하거나 오작동했습니다.

### 4.3. 해결 방안 제시
- **1단계 (IAM 역할 생성):** `security` 스택의 `main.tf`에 ECS Task를 위한 IAM 역할을 생성하고, Secrets Manager 및 Parameter Store 읽기 권한을 부여하는 코드를 추가하도록 제안했습니다.
- **2단계 (Output 추가):** `security` 스택의 `outputs.tf`에 생성된 역할의 ARN을 출력하도록 `output "ecs_task_role_arn"`을 추가하도록 제안했습니다.
- **`admin-server` 헬스 체크 문제 해결:** `admin-server`의 경우, 애플리케이션이 Parameter Store에서 `context-path`를 읽으려고 시도하지만 파라미터가 없어 헬스 체크에 실패하는 문제를 해결하기 위해, `/petclinic/dev/admin/server.servlet.context-path` 파라미터를 AWS에 생성하도록 최종 안내했습니다.

---

## 5. AWS API Gateway 연동 및 정상화

### 5.1. 목표
- 컨테이너 기반의 Spring Cloud Gateway 대신, AWS 관리형 서비스인 **AWS API Gateway**를 사용하도록 전환.

### 5.2. 문제 진단
- `terraform/modules/api-gateway/main.tf` 모듈의 라우팅 로직 오류를 발견했습니다.
- API Gateway가 ALB로 요청을 전달할 때, ALB가 기대하는 경로(`/<service-path>`)가 아닌, 불필요한 서비스 이름이 포함된 잘못된 경로(`/<service-name>/<service-path>`)로 보내고 있었습니다.

### 5.3. 해결 방안
- `api-gateway` 모듈의 `main.tf` 파일 내 `aws_api_gateway_integration` 리소스들의 `uri` 파라미터를 수정하여, ALB가 기대하는 올바른 경로로 요청이 전달되도록 수정했습니다. (총 3곳 수정)
- 수정 완료 후, `terraform apply`를 통해 API Gateway를 배포하고, 새로 생성된 `invoke_url`을 통해 접속하도록 안내했습니다.
