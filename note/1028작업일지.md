# 10/28 작업일지

## 1. 문제 발생: ALB 대상 그룹 비정상 (Unhealthy)

`tg-admin-server` 대상 그룹에서 `Request timed out` 오류와 함께 대상이 `Unhealthy` 상태임을 확인했습니다. 이는 ALB가 애플리케이션의 헬스 체크에 응답을 받지 못하고 있음을 의미했습니다.

## 2. 초기 진단 및 로그 분석

`admin-server` 태스크의 로그를 확인한 결과, 애플리케이션이 **8080 포트**에서 시작되고 있음을 확인했습니다. 반면 ALB 대상 그룹은 **9090 포트**로 헬스 체크를 시도하고 있어 포트 불일치가 문제의 원인으로 지목되었습니다.

## 3. Parameter Store 및 Terraform 설정 분석

`alb-ecs_연결(코드).md` 문서를 통해 Terraform이 `ecs.tf`에서 `data "aws_ssm_parameter"`를 사용하여 각 서비스의 포트 번호를 Parameter Store에서 동적으로 가져오고 있음을 파악했습니다.

제공해주신 Parameter Store 스크린샷(`para.png`)을 통해 실제 파라미터 이름이 `/petclinic/dev/admin/server.port`, `/petclinic/dev/customers/server.port` 등과 같은 형식임을 확인했습니다.

## 4. `application.yml` 설정 분석 및 수정

각 서비스의 `application.yml` 파일을 분석한 결과, 다음과 같은 문제점이 발견되었습니다.

*   **`admin-server`**: 구버전의 Parameter Store 연동 방식을 사용하고 있어, `/petclinic/dev/admin/server.port` 파라미터를 올바르게 읽어오지 못하고 있었습니다. (사용자께서 직접 최신 `import` 방식으로 수정 완료)
*   **`customers-service`, `vets-service`, `visits-service`**: `application.yml` 파일 자체는 Parameter Store의 실제 파라미터 경로와 일치하도록 올바르게 설정되어 있었습니다.

## 5. `ecs.tf` 설정 수정

`ecs.tf` 파일의 `data "aws_ssm_parameter"` 블록에서 `name` 속성이 Parameter Store의 실제 파라미터 이름과 일치하지 않는 문제가 있었습니다.

*   **수정 전**: `name = "/petclinic/dev/${each.value.path_name}.port"`
*   **수정 후**: `name = "/petclinic/dev/${each.value.path_name}/server.port"` (사용자께서 직접 수정 완료)

이 수정으로 `path_name`이 `admin`, `customers` 등으로 간결하게 유지되면서도 Terraform이 `/petclinic/dev/admin/server.port`와 같은 올바른 파라미터 이름을 참조하게 되었습니다.

## 6. 현재 상태 및 다음 단계

현재 모든 서비스의 `application.yml` 설정과 `ecs.tf`의 Terraform 설정이 Parameter Store의 실제 파라미터 이름과 완벽하게 일치하도록 수정되었습니다.

**다음 단계:**

1.  **Terraform 적용**: `ecs.tf` 파일 변경사항을 AWS에 적용하기 위해 `terraform apply`를 실행합니다.
2.  **애플리케이션 이미지 재빌드 및 푸시**: `application.yml` 파일 변경사항을 반영하여 각 서비스의 Docker 이미지를 새로 빌드하고 ECR에 푸시합니다.
3.  **ECS 서비스 재배포**: ECR에 푸시된 최신 이미지를 ECS 서비스가 사용하도록 강제 재배포를 실행합니다.

**만약 위 단계를 모두 수행한 후에도 문제가 지속된다면, ECS Task Role에 Parameter Store를 읽을 수 있는 IAM 권한이 부족한 것이 다음으로 확인해야 할 가장 유력한 원인입니다.**