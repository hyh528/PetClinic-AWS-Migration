# Terraform ECS 작업 역할에 SSM 접근 권한 설정

이 문서는 ECS 작업 실행 시 `no identity-based policy allows the ssm:GetParametersByPath action` 오류가 발생하는 문제를 해결하는 두 가지 방안을 모두 기록합니다.

## 1. 문제 원인

- **오류 메시지**: `...is not authorized to perform: ssm:GetParametersByPath on resource: ... because no identity-based policy allows the ssm:GetParametersByPath action`
- **원인**: ECS 작업의 실행 역할(`ecs_task_execution_role`)에 AWS Systems Manager (SSM) Parameter Store에서 설정 값을 읽어올 수 있는 IAM 권한이 없어서 발생하는 문제입니다. 이 권한이 없으면 애플리케이션은 시작에 필요한 DB 연결 정보나 기타 주요 설정을 가져오지 못해 실행에 실패합니다.

---

## 2. 해결 방안 요약

두 가지 해결 방안이 있습니다. 각 방안은 장단점이 있어 상황에 맞게 선택할 수 있습니다.

### 방안 1: 빠른 해결 (Application 레이어 직접 수정)
- **설명**: `application` 레이어에 직접 IAM 정책을 만들어 역할에 연결합니다. 가장 간단하고 빠르게 문제를 해결할 수 있습니다.
- **장점**: 수정 파일이 하나뿐이라 즉시 적용이 가능합니다.
- **단점**: IAM 정책 코드가 `application` 레이어에 존재하게 되어, `security` 레이어에서 보안 정책을 중앙 관리하는 프로젝트의 설계 원칙에는 위배될 수 있습니다.

### 방안 2: 모범 사례 (Security 레이어 활용)
- **설명**: 프로젝트의 역할 분담 원칙에 따라, IAM 정책을 `security` 레이어에서 중앙 관리하고 `application` 레이어에서는 이 정책을 가져와 사용합니다.
- **장점**: 역할과 책임이 명확히 분리되어 코드 구조가 깔끔해지고 보안 관리가 용이합니다. 이 프로젝트의 다른 권한(`ecs_secrets_policy_arn`) 설정 방식과 일관성을 유지할 수 있습니다.
- **단점**: 여러 파일과 레이어를 수정해야 하므로 과정이 다소 복잡합니다.

--- 

## 3. 상세 코드: 방안 2 (모범 사례)

`security` 레이어와 `application` 레이어의 총 3개 파일을 수정해야 합니다.

### 3.1. `security` 레이어 수정

**1) `terraform/envs/dev/security/main.tf` 파일에 정책 리소스 추가**

파일 맨 아래에 SSM 접근을 허용하는 `aws_iam_policy` 리소스를 추가합니다. `aws_caller_identity` 데이터 소스도 추가하여 AWS 계정 ID를 동적으로 참조합니다.

```terraform
# terraform/envs/dev/security/main.tf 파일 맨 아래에 추가

# VPC 엔드포인트 관련 data source 위에 추가
data "aws_caller_identity" "current" {}

# =================================================
# 7) IAM Policies (중앙 관리)
# =================================================

# --- 7-1. ECS SSM Parameter Store 접근 정책 ---
resource "aws_iam_policy" "ecs_ssm_access_policy" {
  name        = "petclinic-ecs-ssm-access-policy"
  description = "Allows ECS tasks to access specific SSM parameters"
  policy = jsonencode({
    Version = "2012-10-17",
    Statement = [
      {
        Effect = "Allow",
        Action = [
          "ssm:GetParametersByPath",
          "ssm:GetParameters",
          "ssm:GetParameter"
        ],
        Resource = "arn:aws:ssm:${data.aws_region.current.name}:${data.aws_caller_identity.current.account_id}:parameter/petclinic/*"
      }
    ]
  })
}
```

**2) `terraform/envs/dev/security/outputs.tf` 파일에 정책 ARN 출력 추가**

방금 만든 정책의 ARN(고유 식별자)을 다른 레이어에서 가져다 쓸 수 있도록 `output`으로 노출시킵니다.

```terraform
# terraform/envs/dev/security/outputs.tf 파일 맨 아래에 추가

# ECS SSM 접근 정책 ARN
output "ecs_ssm_policy_arn" {
  description = "ECS 작업이 SSM 파라미터 스토어에 접근할 수 있도록 허용하는 IAM 정책의 ARN"
  value       = aws_iam_policy.ecs_ssm_access_policy.arn
}
```

### 3.2. `application` 레이어 수정

**1) `terraform/envs/dev/application/cluster.tf` 파일에 정책 연결 추가**

`security` 레이어에서 노출한 `ecs_ssm_policy_arn`을 원격 상태(remote state)로 읽어와, `ecs_task_execution_role`에 연결합니다.

```terraform
# terraform/envs/dev/application/cluster.tf 파일 맨 아래에 추가

# security 레이어에서 생성한 SSM 접근 정책을 ECS 작업 실행 역할에 연결
resource "aws_iam_role_policy_attachment" "ecs_ssm_policy_attachment" {
  role       = data.aws_iam_role.ecs_task_execution_role.name
  policy_arn = data.terraform_remote_state.security.outputs.ecs_ssm_policy_arn
}
```

--- 

## 4. 적용 순서

1.  **`security` 레이어 적용**: `terraform/envs/dev/security` 디렉토리로 이동하여 `terraform apply`를 실행합니다.
2.  **`application` 레이어 적용**: `terraform/envs/dev/application` 디렉토리로 이동하여 `terraform apply`를 실행합니다.
