# 10월 29일 작업일지: ALB Unhealthy 상태 해결 과정

## 1. 초기 문제: 모든 서비스 Unhealthy 및 포트 불일치

- **현상**: 모든 서비스의 ALB 대상 그룹이 `Unhealthy` 상태를 보임.
- **원인 분석**: `admin-server` 로그 확인 결과, 애플리케이션은 **8080 포트**로 실행되나 대상 그룹은 **9090 포트**를 바라보고 있었음. 이는 다른 서비스들도 마찬가지일 것으로 추정.
- **조치**: `ecs.tf`의 파라미터 조회 로직과 각 서비스의 `application.yml` 설정을 확인하고 수정하여, 모든 서비스가 Parameter Store에서 올바른 포트 번호를 읽어와 해당 포트로 실행되도록 함.

---

## 2. 2차 문제: `admin-server`의 설정 파일 오타

- **현상**: `admin-server`만 계속 `Unhealthy` 상태. 로그 확인 결과 `Unable to load AWS parameter from /petclinic/common/"` 경고 발생.
- **원인 분석**: `admin-server`의 `application.yml` 파일 내 `spring.config.import` 경로에 불필요한 쌍따옴표(`"`) 오타가 있었음.
- **조치**: `admin-server`의 `application.yml` 파일에서 해당 오타를 수정하고, 이미지를 다시 빌드하여 배포함.

---

## 3. 3차 문제: `customers-service`의 데이터베이스 스키마 오류

- **현상**: `customers-service`가 `Unhealthy` 상태. 로그 확인 결과 `Table 'owners' already exists` 및 `foreign key ... incompatible` 오류 발생.
- **원인 분석**: `application.yml`의 `spring.jpa.hibernate.ddl-auto` 설정이 `create`로 되어 있어, 애플리케이션 시작 시 이미 존재하는 테이블을 다시 생성하려고 시도하며 발생한 문제.
- **조치**: `customers-service`의 `application.yml` 파일에서 `ddl-auto` 값을 `update`로 변경하고, 이미지를 다시 빌드하여 배포함.

---

## 4. 최종 문제: ALB와 ECS 서비스 간 네트워크 차단

- **현상**: 모든 서비스의 애플리케이션 로그는 정상적으로 뜨고 올바른 포트(9090, 8081, 8082, 8083)로 실행되었으나, ALB 대상 그룹에서는 여전히 `Request timed out` 또는 `Health checks failed`와 함께 `Unhealthy` 상태가 지속됨.
- **원인 분석**: 애플리케이션은 정상이므로, ALB의 헬스 체크 트래픽이 ECS 서비스의 보안 그룹(방화벽)에 의해 차단되고 있는 것으로 최종 결론.

- **최종 해결 방안**: 각 서비스의 보안 그룹에 ALB로부터 오는 트래픽을 허용하는 인바운드 규칙을 추가.

  1.  **ALB 보안 그룹 ID 확인**: `petclinic-main-alb`에 연결된 보안 그룹 ID가 **`sg-077111d76d5932890`** 임을 확인함.

  2.  **각 ECS 서비스의 보안 그룹에 규칙 추가**:
      -   `admin-server`의 보안 그룹(`sg-0310941362800b6b4`)에 아래 규칙 추가 후 재배포
          - **포트**: `9090`
          - **소스**: `sg-077111d76d5932890`

      -   `customers-service`의 보안 그룹에 아래 규칙 추가 후 재배포
          - **포트**: `8081`
          - **소스**: `sg-077111d76d5932890`

      -   `vets-service`의 보안 그룹에 아래 규칙 추가 후 재배포
          - **포트**: `8082`
          - **소스**: `sg-077111d76d5932890`

      -   `visits-service`의 보안 그룹에 아래 규칙 추가 후 재배포
          - **포트**: `8083`
          - **소스**: `sg-077111d76d5932890`

## 5. 추가 발견 사항: `vets-service`의 Zipkin 경고

- **현상**: `vets-service` 로그에서 `I/O error on POST request for "http://localhost:9411/api/v2/spans"` 경고 발견.
- **분석**: 분산 추적 시스템인 Zipkin 서버로 데이터를 보내려다 실패한 로그. 현재 Zipkin 서버가 구성되어 있지 않아 발생하는 자연스러운 경고이며, 애플리케이션 실행을 막는 원인은 아님. 추후 Zipkin을 도입할 경우에만 수정이 필요한 부분임.