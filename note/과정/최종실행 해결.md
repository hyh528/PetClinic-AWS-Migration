# Terraform Plan ìµœì¢… ì‹¤í–‰ í•´ê²° ê³¼ì • ìš”ì•½ (2025-10-15)

## ëª©í‘œ
`terraform/envs/dev/application` ë””ë ‰í„°ë¦¬ì—ì„œ `terraform init` ë° `terraform plan` ëª…ë ¹ì–´ë¥¼ ì„±ê³µì ìœ¼ë¡œ ì‹¤í–‰ì‹œí‚¤ëŠ” ê²ƒ.

## ìµœì¢… ìš”ì•½
`terraform init`ë¶€í„° `terraform plan`ê¹Œì§€ ë°œìƒí•˜ëŠ” ì—¬ëŸ¬ ì˜¤ë¥˜ë¥¼ ë‹¨ê³„ì ìœ¼ë¡œ í•´ê²°í–ˆìŠµë‹ˆë‹¤. ì£¼ìš” ì˜¤ë¥˜ëŠ” ëª¨ë“ˆ ì¤‘ë³µ ì„ ì–¸, ëª¨ë“ˆ ê²½ë¡œ ì˜¤íƒ€, ì›ê²© ìƒíƒœ(remote state) ì„¤ì • ì˜¤ë¥˜, ê·¸ë¦¬ê³  ëª¨ë“ˆ ë³€ìˆ˜ ëˆ„ë½ì´ì—ˆìŠµë‹ˆë‹¤. ê° ë¬¸ì œë¥¼ ì§„ë‹¨í•˜ê³ , ì´ˆì‹¬ìê°€ ì´í•´í•˜ê¸° ì‰¬ìš´ ë°©ì‹ìœ¼ë¡œ ì›ì¸ì„ ì„¤ëª…í•˜ë©° ì½”ë“œë¥¼ ìˆ˜ì •í•˜ì—¬ ìµœì¢…ì ìœ¼ë¡œ `terraform plan` ì‹¤í–‰ì— ì„±ê³µí–ˆìŠµë‹ˆë‹¤.

---

## ì˜¤ë¥˜ í•´ê²° ê³¼ì • ìƒì„¸

<details>
<summary><strong>1. `terraform init` ì‹¤íŒ¨: ëª¨ë“ˆ ì¤‘ë³µ ì„ ì–¸ ë° ê²½ë¡œ ì˜¤ë¥˜</strong></summary>

- **ì˜¤ë¥˜ 1: `Duplicate module call`**
    - **ì›ì¸**: `main.tf` íŒŒì¼ì— ë‹¤ë¥¸ `.tf` íŒŒì¼(`cloudmap.tf`, `ecr.tf`)ì— ì´ë¯¸ ì„ ì–¸ëœ ëª¨ë“ˆì´ ì¤‘ë³µìœ¼ë¡œ í¬í•¨ë˜ì–´ ìˆì—ˆìŠµë‹ˆë‹¤.
    - **í•´ê²°**: `main.tf`ì˜ ì¤‘ë³µëœ ë‚´ìš©ì„ ì‚­ì œí–ˆìŠµë‹ˆë‹¤.

- **ì˜¤ë¥˜ 2: `Unreadable module directory`**
    - **ì›ì¸**: `ecs` ëª¨ë“ˆì„ ì°¸ì¡°í•´ì•¼ í•˜ëŠ”ë°, ì‹¤ì œ ë””ë ‰í„°ë¦¬ ì´ë¦„ì´ `esc`ë¡œ ì˜¤íƒ€ê°€ ìˆì—ˆìŠµë‹ˆë‹¤.
    - **í•´ê²°**: `terraform/modules/esc` ë””ë ‰í„°ë¦¬ ì´ë¦„ì„ `terraform/modules/ecs`ë¡œ ë³€ê²½í–ˆìŠµë‹ˆë‹¤.
</details>

<details>
<summary><strong>2. `terraform plan` ì‹¤íŒ¨: ì„ ì–¸ë˜ì§€ ì•Šì€ ëª¨ë“ˆ ë° ë³€ìˆ˜ ì˜¤ë¥˜</strong></summary>

- **ì˜¤ë¥˜ 3: `Reference to undeclared module`**
    - **ì›ì¸**: `cloudmap.tf`ì—ì„œ VPC IDë¥¼ ê°€ì ¸ì˜¤ê¸° ìœ„í•´ `module.vpc.vpc_id`ë¥¼ ì‚¬ìš©í–ˆì§€ë§Œ, `application` ë ˆì´ì–´ì—ëŠ” `vpc` ëª¨ë“ˆì´ ì„ ì–¸ë˜ì–´ ìˆì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.
    - **í•´ê²°**: `network` ë ˆì´ì–´ì˜ ì›ê²© ìƒíƒœ ê²°ê³¼ë¬¼ì„ ì‚¬ìš©í•˜ë„ë¡ `data.terraform_remote_state.network.outputs.vpc_id`ë¡œ ìˆ˜ì •í–ˆìŠµë‹ˆë‹¤.

- **ì˜¤ë¥˜ 4: `Value for undeclared variable` (ê²½ê³ )**
    - **ì›ì¸**: `dev.tfvars` íŒŒì¼ì—ëŠ” `database_state_profile` ë³€ìˆ˜ê°€ ìˆì—ˆì§€ë§Œ, `variables.tf` íŒŒì¼ì—ì„œëŠ” í•´ë‹¹ ë³€ìˆ˜ ì„ ì–¸ì´ ì£¼ì„ ì²˜ë¦¬ë˜ì–´ ìˆì—ˆìŠµë‹ˆë‹¤.
    - **í•´ê²°**: `variables.tf` íŒŒì¼ì—ì„œ `database_state_profile` ë³€ìˆ˜ì˜ ì£¼ì„ì„ ì œê±°í•˜ì—¬ í™œì„±í™”í–ˆìŠµë‹ˆë‹¤.
</details>

<details>
<summary><strong>3. `terraform plan` ì‹¤íŒ¨: ì›ê²© ìƒíƒœ(Remote State) ì˜¤ë¥˜</strong></summary>

- **ì˜¤ë¥˜ 5: `Unable to find remote state`**
    - **ì›ì¸ 1 (ì˜ëª»ëœ ì°¸ì¡°)**: `data.tf`ì—ì„œ `security` ë ˆì´ì–´ì˜ ìƒíƒœë¥¼ ì¡°íšŒí•  ë•Œ, ë‹´ë‹¹ìê°€ `hwigwon`ì„ì—ë„ ë¶ˆêµ¬í•˜ê³  `yeonghyeon`ì˜ í”„ë¡œí•„ê³¼ ê²½ë¡œë¡œ ì˜ëª» ì„¤ì •ë˜ì–´ ìˆì—ˆìŠµë‹ˆë‹¤.
    - **í•´ê²° 1**: `security` ì›ê²© ìƒíƒœ ë¸”ë¡ì˜ `key`ì™€ `profile`ì„ `hwigwon`ì˜ ì •ë³´ (`var.security_state_profile`)ë¡œ ì˜¬ë°”ë¥´ê²Œ ìˆ˜ì •í–ˆìŠµë‹ˆë‹¤.
    - **ì›ì¸ 2 (ê·¼ë³¸ ì›ì¸)**: `network`ì™€ `security` ë ˆì´ì–´ê°€ `apply`ëœ ì ì´ ì—†ì–´ S3 ë²„í‚·ì— ìƒíƒœ íŒŒì¼ì´ ì‹¤ì œë¡œ ì¡´ì¬í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.
    - **í•´ê²° 2**: ë‹´ë‹¹ìê°€ ê° ë ˆì´ì–´ë¥¼ `apply`í•˜ì—¬ S3 ë²„í‚·ì— ìƒíƒœ íŒŒì¼ì„ ìƒì„±í–ˆìŠµë‹ˆë‹¤.

</details>

<details>
<summary><strong>4. `terraform plan` ì‹¤íŒ¨: ëª¨ë“ˆ ì…ë ¥ ë³€ìˆ˜ ëˆ„ë½</strong></summary>

- **ì˜¤ë¥˜ 6: `expected length of name to be in the range (1 - 1024), got`**
    - **ì›ì¸**: `cloudmap` ëª¨ë“ˆì— í•„ìˆ˜ ì…ë ¥ ë³€ìˆ˜ì¸ `namespace_name`ì´ ì „ë‹¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. (1ë²ˆ ì˜¤ë¥˜ í•´ê²° ì‹œ `main.tf`ì—ì„œ ì‚­ì œë¨)
    - **í•´ê²°**: `cloudmap.tf`ì˜ `cloudmap` ëª¨ë“ˆ í˜¸ì¶œë¶€ì— `namespace_name = "petclinic.test"` ì½”ë“œë¥¼ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤.
</details>

---

## ìµœì¢… ìˆ˜ì • ì™„ë£Œëœ íŒŒì¼

ì•„ë˜ëŠ” ëª¨ë“  ì˜¤ë¥˜ë¥¼ í•´ê²°í•œ í›„ì˜ ìµœì¢… íŒŒì¼ ë‚´ìš©ì…ë‹ˆë‹¤.

<details>
<summary><b>ğŸ“„ terraform/envs/dev/application/main.tf</b></summary>

```terraform
# ë°°í¬í•  ì„œë¹„ìŠ¤ ëª©ë¡ì„ mapìœ¼ë¡œ ì •ì˜
locals {
  ecs_services = {
    "customers-service" = {
      container_port = 8080
      image_uri      = "${module.ecr.repository_urls["customers-service"]}:latest"
      priority       = 100 # ë¦¬ìŠ¤ë„ˆ ê·œì¹™ ìš°ì„ ìˆœìœ„ (ê²¹ì¹˜ë©´ ì•ˆ ë¨)
    },
    "vets-service" = {
      container_port = 8080
      image_uri      = "${module.ecr.repository_urls["vets-service"]}:latest"
      priority       = 110
    },
    "visits-service" = {
      container_port = 8080
      image_uri      = "${module.ecr.repository_urls["visits-service"]}:latest"
      priority       = 120
    }
  }
}

# for_eachë¥¼ ì‚¬ìš©í•˜ì—¬ ì„œë¹„ìŠ¤ë³„ë¡œ ecs ëª¨ë“ˆ í˜¸ì¶œ
module "ecs" {
  for_each = local.ecs_services
  source   = "../../../modules/ecs"

  # --- ê³µìœ  ë¦¬ì†ŒìŠ¤ ê°’ ì „ë‹¬ ---
  aws_region                  = var.aws_region
  vpc_id                      = data.terraform_remote_state.network.outputs.vpc_id
  private_subnet_ids          = values(data.terraform_remote_state.network.outputs.private_app_subnet_ids)
  ecs_service_sg_id           = data.terraform_remote_state.security.outputs.app_security_group_id
  cluster_id                  = aws_ecs_cluster.main.id
  ecs_task_execution_role_arn = aws_iam_role.ecs_task_execution_role.arn
  listener_arn                = aws_lb_listener.http.arn

  # --- ì„œë¹„ìŠ¤ë³„ ê°’ ì „ë‹¬ ---
  service_name      = each.key
  image_uri         = each.value.image_uri
  container_port    = each.value.container_port
  listener_priority = each.value.priority


  # ê° ì„œë¹„ìŠ¤ì˜ ì´ë¦„(each.key)ì— í•´ë‹¹í•˜ëŠ” Cloud Map ì„œë¹„ìŠ¤ì˜ ARNì„ ì „ë‹¬
  cloudmap_service_arn = module.cloudmap.service_arns[each.key]
}
```
</details>

<details>
<summary><b>ğŸ“„ terraform/envs/dev/application/cloudmap.tf</b></summary>

```terraform
module "cloudmap" {
  # ëª¨ë“ˆ ê²½ë¡œ
  source = "../../../modules/cloudmap"

  namespace_name = "petclinic.test"

  # ì‚¬ìš©í•  VPC
  vpc_id = data.terraform_remote_state.network.outputs.vpc_id

  #Cloudmapì— ë“±ë¡í•  ë§ˆì´í¬ë¡œ ì„œë¹„ìŠ¤ ëª©ë¡
  service_name_map = {
    "customers-service" = "customer service"
    "vets-service"      = "vets-service"
    "visits-service"    = "visits-service"

  }
  
  tags = {
    Environment = "dev"
    Project     = "PetClinic"
  }
} #Cloud Map ëª¨ë“ˆ
```
</details>

<details>
<summary><b>ğŸ“„ terraform/envs/dev/application/data.tf</b></summary>

```terraform
data "terraform_remote_state" "network" {
  backend = "s3"
  config = {
    bucket  = "petclinic-tfstate-team-jungsu-kopo"
    key     = "dev/yeonghyeon/network/terraform.tfstate"
    region  = var.aws_region
    profile = var.network_state_profile
  }
} # network ë ˆì´ì–´ ê²°ê³¼

data "terraform_remote_state" "security" {
  backend = "s3"
  config = {
    bucket  = "petclinic-tfstate-team-jungsu-kopo"
    key     = "dev/hwigwon/security/terraform.tfstate"
    region  = var.aws_region
    profile = var.security_state_profile
  }
} # security ë ˆì´ì–´ ê²°ê³¼
```
</details>

<details>
<summary><b>ğŸ“„ terraform/envs/dev/application/variables.tf</b></summary>

```terraform
variable "aws_profile" {
  description = "ì¸ì¦ìš© AWS í”„ë¡œí•„"
  type        = string
}

variable "aws_region" {
  description = "ë¦¬ì†ŒìŠ¤ìš© AWS ë¦¬ì „"
  type        = string
}
variable "network_state_profile" {
  description = "ë„¤íŠ¸ì›Œí¬ ìƒíƒœ íŒŒì¼ ì ‘ê·¼ìš© AWS í”„ë¡œí•„"
  type        = string
}

variable "security_state_profile" {
  description = "ë³´ì•ˆ ìƒíƒœ íŒŒì¼ ì ‘ê·¼ìš© AWS í”„ë¡œí•„"
  type        = string
}

variable "database_state_profile" {
  description = "DB ìƒíƒœ íŒŒì¼ ì ‘ê·¼ìš© AWS í”„ë¡œí•„"
  type        = string
}
```
</details>
