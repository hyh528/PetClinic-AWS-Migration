# 08-API Gateway Layer

## ê°œìš”

AWS API Gatewayë¥¼ ì‚¬ìš©í•˜ì—¬ Spring Cloud Gatewayë¥¼ ëŒ€ì²´í•˜ëŠ” ë ˆì´ì–´ì…ë‹ˆë‹¤. ë‹¨ì¼ ì±…ì„ ì›ì¹™(SRP)ì„ ì ìš©í•˜ì—¬ API Gateway ê´€ë¦¬ë§Œ ë‹´ë‹¹í•˜ë©°, AWS ë„¤ì´í‹°ë¸Œ ì„œë¹„ìŠ¤ì˜ ì¥ì ì„ í™œìš©í•©ë‹ˆë‹¤.

## ì•„í‚¤í…ì²˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Client        â”‚    â”‚  API Gateway    â”‚    â”‚  ALB + ECS      â”‚
â”‚                 â”‚    â”‚                 â”‚    â”‚                 â”‚
â”‚ - Web Browser   â”‚â”€â”€â”€â–¶â”‚ - ë¼ìš°íŒ…        â”‚â”€â”€â”€â–¶â”‚ - ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ â”‚
â”‚ - Mobile App    â”‚    â”‚ - ìŠ¤ë¡œí‹€ë§      â”‚    â”‚ - ë¡œë“œ ë°¸ëŸ°ì‹±    â”‚
â”‚ - API Client    â”‚    â”‚ - ì¸ì¦/ì¸ê°€     â”‚    â”‚ - í—¬ìŠ¤ì²´í¬      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚ - ëª¨ë‹ˆí„°ë§      â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚ - CORS          â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                       â”‚  Lambda GenAI   â”‚
                       â”‚                 â”‚
                       â”‚ - AI ì„œë¹„ìŠ¤     â”‚
                       â”‚ - Bedrock í†µí•©  â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ì£¼ìš” ê¸°ëŠ¥

### Spring Cloud Gateway ëŒ€ì²´
- **AWS ë„¤ì´í‹°ë¸Œ ì„œë¹„ìŠ¤**: ì™„ì „ ê´€ë¦¬í˜• API Gateway
- **ìë™ ìŠ¤ì¼€ì¼ë§**: íŠ¸ë˜í”½ì— ë”°ë¥¸ ìë™ í™•ì¥
- **ë‚´ì¥ ëª¨ë‹ˆí„°ë§**: CloudWatch í†µí•©
- **ë¹„ìš© íš¨ìœ¨ì„±**: ìš”ì²­ë‹¹ ê³¼ê¸ˆ ëª¨ë¸

### í•µì‹¬ ê¸°ëŠ¥
1. **ë¼ìš°íŒ…**: ê²½ë¡œ ê¸°ë°˜ ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ë¼ìš°íŒ…
2. **ìŠ¤ë¡œí‹€ë§**: ìš”ì²­ ìˆ˜ ì œí•œ ë° ë²„ìŠ¤íŠ¸ ì œì–´
3. **CORS**: Cross-Origin Resource Sharing ì§€ì›
4. **ëª¨ë‹ˆí„°ë§**: CloudWatch ì•ŒëŒ ë° ëŒ€ì‹œë³´ë“œ
5. **Lambda í†µí•©**: GenAI ì„œë¹„ìŠ¤ ì—°ë™

## ì˜ì¡´ì„±

ì´ ë ˆì´ì–´ëŠ” ë‹¤ìŒ ë ˆì´ì–´ë“¤ì— ì˜ì¡´í•©ë‹ˆë‹¤:

1. **01-network**: VPC ì •ë³´ (ì„ íƒì )
2. **02-security**: IAM ì—­í•  (ì„ íƒì )
3. **07-application**: ALB DNS ì´ë¦„

## ì‚¬ìš©ë²•

### 1. ì´ˆê¸°í™”
```bash
cd terraform/layers/08-api-gateway
terraform init -backend-config="../../envs/dev/backend.hcl"
```

### 2. ê³„íš í™•ì¸
```bash
terraform plan -var-file="../../envs/dev/terraform.tfvars"
```

### 3. ë°°í¬
```bash
terraform apply -var-file="../../envs/dev/terraform.tfvars"
```

## ì£¼ìš” ë³€ìˆ˜

| ë³€ìˆ˜ëª… | ì„¤ëª… | ê¸°ë³¸ê°’ | í•„ìˆ˜ |
|--------|------|--------|------|
| `name_prefix` | ë¦¬ì†ŒìŠ¤ ì´ë¦„ ì ‘ë‘ì‚¬ | - | âœ… |
| `environment` | ë°°í¬ í™˜ê²½ | - | âœ… |
| `stage_name` | API Gateway ìŠ¤í…Œì´ì§€ | `v1` | âŒ |
| `throttle_rate_limit` | ì´ˆë‹¹ ìš”ì²­ ìˆ˜ ì œí•œ | `1000` | âŒ |
| `throttle_burst_limit` | ë²„ìŠ¤íŠ¸ ìš”ì²­ ìˆ˜ ì œí•œ | `2000` | âŒ |
| `enable_lambda_integration` | Lambda í†µí•© í™œì„±í™” | `false` | âŒ |
| `enable_monitoring` | ëª¨ë‹ˆí„°ë§ í™œì„±í™” | `true` | âŒ |
| `enable_cors` | CORS ì§€ì› | `true` | âŒ |

## ë¼ìš°íŒ… êµ¬ì„±

### ê¸°ë³¸ ë¼ìš°íŒ…
```
GET  /api/customers/*  â†’ ALB/customers-service
GET  /api/vets/*       â†’ ALB/vets-service
GET  /api/visits/*     â†’ ALB/visits-service
POST /api/genai/*      â†’ Lambda/bedrock-function
GET  /admin/*          â†’ ALB/admin-server
```

### Lambda í†µí•© (GenAI)
```
POST /api/genai/chat          â†’ Lambda Function
POST /api/genai/recommendations â†’ Lambda Function
```

## ì¶œë ¥ê°’

### API Gateway ì •ë³´
- `api_gateway_id`: API Gateway REST API ID
- `api_gateway_invoke_url`: API í˜¸ì¶œ URL
- `api_gateway_stage_name`: ìŠ¤í…Œì´ì§€ ì´ë¦„
- `api_gateway_execution_arn`: ì‹¤í–‰ ARN

### ë¼ìš°íŒ… ì •ë³´
- `routing_configuration`: ë¼ìš°íŒ… ì„¤ì • ì •ë³´
- `service_resources`: ì„œë¹„ìŠ¤ë³„ ë¦¬ì†ŒìŠ¤ ì •ë³´

### ëª¨ë‹ˆí„°ë§ ì •ë³´
- `monitoring_info`: ëª¨ë‹ˆí„°ë§ ì„¤ì • ë° ëŒ€ì‹œë³´ë“œ ì •ë³´

## ê°œì„ ì‚¬í•­

### âœ… ì™„ë£Œëœ ê°œì„ ì‚¬í•­
1. **ê³µìœ  ë³€ìˆ˜ ì‹œìŠ¤í…œ ì ìš©**: í•˜ë“œì½”ë”© ì œê±°
2. **ê°œì¸ ê²½ë¡œ ìƒíƒœ ì°¸ì¡° ì œê±°**: í‘œì¤€í™”ëœ ìƒíƒœ ì°¸ì¡°
3. **ë‹¨ì¼ ì±…ì„ ì›ì¹™ ì ìš©**: API Gateway ê´€ë¦¬ë§Œ ë‹´ë‹¹
4. **AWS ë„¤ì´í‹°ë¸Œ ì„œë¹„ìŠ¤**: Spring Cloud Gateway ì™„ì „ ëŒ€ì²´
5. **ëª¨ë‹ˆí„°ë§ í†µí•©**: CloudWatch ì•ŒëŒ ë° ëŒ€ì‹œë³´ë“œ

### ğŸ”„ í–¥í›„ ê°œì„  ê³„íš
1. **ì¸ì¦/ì¸ê°€**: Cognito í†µí•©
2. **API í‚¤ ê´€ë¦¬**: ì‚¬ìš©ëŸ‰ ê³„íš ë° API í‚¤
3. **ìºì‹±**: ì‘ë‹µ ìºì‹± í™œì„±í™”
4. **WAF í†µí•©**: ë³´ì•ˆ ê°•í™”

## ëª¨ë‹ˆí„°ë§

### CloudWatch ë©”íŠ¸ë¦­
- API Gateway ìš”ì²­ ìˆ˜ ë° ì‘ë‹µ ì‹œê°„
- 4XX/5XX ì—ëŸ¬ìœ¨
- í†µí•© ì§€ì—°ì‹œê°„
- ìŠ¤ë¡œí‹€ë§ ë°œìƒ íšŸìˆ˜

### ì•ŒëŒ ì„¤ì •
```hcl
ì•ŒëŒ ì„ê³„ê°’:
  4XX ì—ëŸ¬: 20ê°œ/ë¶„
  5XX ì—ëŸ¬: 10ê°œ/ë¶„
  ì§€ì—°ì‹œê°„: 2000ms
  í†µí•© ì§€ì—°ì‹œê°„: 1500ms
```

### ëŒ€ì‹œë³´ë“œ
- API Gateway ì„±ëŠ¥ ë©”íŠ¸ë¦­
- ì„œë¹„ìŠ¤ë³„ ìš”ì²­ ë¶„í¬
- ì—ëŸ¬ìœ¨ ë° ì§€ì—°ì‹œê°„ ì¶”ì´

## Spring Cloud Gateway ë§ˆì´ê·¸ë ˆì´ì…˜

### ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ í•­ëª©
- âœ… ë¼ìš°íŒ… ê·œì¹™ ì´ì „
- âœ… ìŠ¤ë¡œí‹€ë§ ì„¤ì • ì´ì „
- âœ… CORS ì„¤ì • ì´ì „
- âœ… ëª¨ë‹ˆí„°ë§ ì„¤ì • ì´ì „
- âœ… Lambda í†µí•© (GenAI)

### ë§ˆì´ê·¸ë ˆì´ì…˜ í˜œíƒ
1. **ìš´ì˜ ë¶€ë‹´ ì œê±°**: ì„œë²„ ê´€ë¦¬ ë¶ˆí•„ìš”
2. **ìë™ ìŠ¤ì¼€ì¼ë§**: íŠ¸ë˜í”½ ê¸‰ì¦ ëŒ€ì‘
3. **ë¹„ìš© ìµœì í™”**: ì‚¬ìš©ëŸ‰ ê¸°ë°˜ ê³¼ê¸ˆ
4. **ë³´ì•ˆ ê°•í™”**: AWS ë³´ì•ˆ ê¸°ëŠ¥ í™œìš©
5. **ëª¨ë‹ˆí„°ë§ ê°œì„ **: CloudWatch ë„¤ì´í‹°ë¸Œ í†µí•©

## ë¬¸ì œ í•´ê²°

### ì¼ë°˜ì ì¸ ë¬¸ì œ
1. **502 Bad Gateway**: ALB ì—°ê²° í™•ì¸
2. **ìŠ¤ë¡œí‹€ë§ ì—ëŸ¬**: ìš”ì²­ ì œí•œ ì„¤ì • í™•ì¸
3. **CORS ì—ëŸ¬**: CORS ì„¤ì • í™•ì¸
4. **Lambda íƒ€ì„ì•„ì›ƒ**: í•¨ìˆ˜ ì‹¤í–‰ ì‹œê°„ í™•ì¸

### ë””ë²„ê¹… ëª…ë ¹ì–´
```bash
# API Gateway ìƒíƒœ í™•ì¸
aws apigateway get-rest-api --rest-api-id {api_id}

# ë°°í¬ ìƒíƒœ í™•ì¸
aws apigateway get-deployment --rest-api-id {api_id} --deployment-id {deployment_id}

# CloudWatch ë¡œê·¸ í™•ì¸
aws logs get-log-events --log-group-name "API-Gateway-Execution-Logs_{api_id}/{stage_name}"
```

## ë¹„ìš© ìµœì í™”

### ìš”ì²­ë‹¹ ê³¼ê¸ˆ
```
API Gateway ìš”ì²­: $3.50 per million requests
ë°ì´í„° ì „ì†¡: $0.09 per GB (ì²« 10TB)
CloudWatch ë¡œê·¸: $0.50 per GB ingested
```

### ë¹„ìš© ì ˆê° ë°©ì•ˆ
1. **ìºì‹± í™œìš©**: ë°˜ë³µ ìš”ì²­ ìºì‹±
2. **ë¡œê·¸ ìµœì í™”**: í•„ìš”í•œ ë¡œê·¸ë§Œ í™œì„±í™”
3. **ì••ì¶• í™œì„±í™”**: ì‘ë‹µ ë°ì´í„° ì••ì¶•
4. **ì‚¬ìš©ëŸ‰ ëª¨ë‹ˆí„°ë§**: ë¹„ì •ìƒì  ì‚¬ìš© íŒ¨í„´ ê°ì§€

## íƒœê·¸ ì „ëµ

ëª¨ë“  ë¦¬ì†ŒìŠ¤ì—ëŠ” ë‹¤ìŒ íƒœê·¸ê°€ ìë™ìœ¼ë¡œ ì ìš©ë©ë‹ˆë‹¤:

```hcl
{
  Environment = var.environment
  Layer       = "08-api-gateway"
  Component   = "api-gateway"
  ManagedBy   = "terraform"
  # + ì‚¬ìš©ì ì •ì˜ íƒœê·¸ (var.tags)
}
```