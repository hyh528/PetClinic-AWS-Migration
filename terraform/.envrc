# =============================================================================
# direnv 설정 - Terraform CLI 자동 변수 주입
# =============================================================================
# 목적: 모든 terraform 명령에 공통/환경 변수를 자동으로 주입
# 사용법: direnv allow 명령으로 활성화
# 참고: https://direnv.net/

# 프로젝트 루트 및 환경 설정
export REPO_ROOT="$(git rev-parse --show-toplevel 2>/dev/null || pwd)"
export ENV="${ENV:-dev}"

# 공통 및 환경 tfvars 파일 경로
COMMON_VARS="$REPO_ROOT/shared/common.tfvars"
ENV_VARS="$REPO_ROOT/envs/${ENV}.tfvars"

# TF_CLI_ARGS_plan: plan 명령에만 공통/환경 변수 자동 주입
# (apply는 저장된 plan 파일을 사용하므로 별도 변수 불필요)
if [[ -f "$COMMON_VARS" && -f "$ENV_VARS" ]]; then
    export TF_CLI_ARGS_plan="-var-file=$COMMON_VARS -var-file=$ENV_VARS"
    echo "Terraform 자동 변수 주입 활성화: $ENV 환경"
    echo "  - 공통 변수: $COMMON_VARS"
    echo "  - 환경 변수: $ENV_VARS"
elif [[ -f "$ENV_VARS" ]]; then
    export TF_CLI_ARGS_plan="-var-file=$ENV_VARS"
    echo "Terraform 자동 변수 주입 활성화: $ENV 환경 (공통 변수 없음)"
    echo "  - 환경 변수: $ENV_VARS"
else
    echo "경고: tfvars 파일을 찾을 수 없습니다"
    echo "  - 공통 변수: $COMMON_VARS"
    echo "  - 환경 변수: $ENV_VARS"
fi

# 환경 변경 시 자동 재적용
export DIRENV_WARN_TIMEOUT=10s